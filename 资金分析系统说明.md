

# 资金分析系统主要模型说明

#### 基础SQL说明

> 此SQL出现在大部分的模型运算中，功能就是在原有的mz_bank_records表扩充出来一些关于组详情的字段以备后续运算

```sql
select
	*,
	(case
		when CXKHGROUPNAME is null then CXKH
		else CXKHGROUPNAME
	end) as CXKHGROUP,
	(case
		when JYDFZKHGROUPNAME is null then JYDFZKH
		else JYDFZKHGROUPNAME
	end) as JYDFZKHGROUP,
	(case
		when JYZJHMGROUPNAME is null then JYZJHM
		else JYZJHMGROUPNAME
	end) as JYZJHMGROUP,
	(case
		when JYDFZJHMGROUPNAME is null then JYDFZJHM
		else JYDFZJHMGROUPNAME
	end) as JYDFZJHMGROUP,
	(case
		when JYMCGROUPNAME is null then JYMC
		else JYMCGROUPNAME
	end) as JYMCGROUP,
	(case
		when JYDFMCGROUPNAME is null then JYDFMC
		else JYDFMCGROUPNAME
	end) as JYDFMCGROUP
from
	(
	select
		*
	from
		mz_bank_records
	where
		AJID = 1447663931)BANK
left join(
	select
		GROUPNAME as CXKHGROUPNAME,
		GROUPMEMBER
	from
		mark_group_detail
	where
		AJID = 1447663931
		and TABLECOLUMN = 'CXKH&JYDFZKH'
		and TABLENAME = 'mz_bank_records')GROUP1 on
	BANK.CXKH = GROUP1.GROUPMEMBER
left join (
	select
		GROUPNAME as JYDFZKHGROUPNAME,
		GROUPMEMBER
	from
		mark_group_detail
	where
		AJID = 1447663931
		and TABLECOLUMN = 'CXKH&JYDFZKH'
		and TABLENAME = 'mz_bank_records')GROUP2 on
	BANK.JYDFZKH = GROUP2.GROUPMEMBER
left join (
	select
		GROUPNAME as JYZJHMGROUPNAME,
		GROUPMEMBER
	from
		mark_group_detail
	where
		AJID = 1447663931
		and TABLECOLUMN = 'JYZJHM&JYDFZJHM'
		and TABLENAME = 'mz_bank_records')GROUP3 on
	BANK.JYZJHM = GROUP3.GROUPMEMBER
left join (
	select
		GROUPNAME as JYDFZJHMGROUPNAME,
		GROUPMEMBER
	from
		mark_group_detail
	where
		AJID = 1447663931
		and TABLECOLUMN = 'JYZJHM&JYDFZJHM'
		and TABLENAME = 'mz_bank_records')GROUP4 on
	BANK.JYDFZJHM = GROUP4.GROUPMEMBER
left join (
	select
		GROUPNAME as JYMCGROUPNAME,
		GROUPMEMBER
	from
		mark_group_detail
	where
		AJID = 1447663931
		and TABLECOLUMN = 'JYMC&JYDFMC'
		and TABLENAME = 'mz_bank_records')GROUP5 on
	BANK.JYMC = GROUP5.GROUPMEMBER
left join (
	select
		GROUPNAME as JYDFMCGROUPNAME,
		GROUPMEMBER
	from
		mark_group_detail
	where
		AJID = 1447663931
		and TABLECOLUMN = 'JYMC&JYDFMC'
		and TABLENAME = 'mz_bank_records')GROUP6 on
	BANK.JYDFMC = GROUP6.GROUPMEMBER
```

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cmn6ooytj31he0po4qp.jpg)

### 一、异常行为发现模型

#### 1. 大额交易行为账户发现

> 统计所有交易方账户的交易金额和交易笔数。
>
> 旨在发现交易行为中，交易金额超过某一阈值的一大批账户的发现模型，着重突出的是交易方。
>
> 统计结果：交易卡号，交易名称，交易证件号码，交易总金额，交易总笔数，进账金额，进账笔数，出账金额，出账笔数，进出帐差额。

```sql
select
	max(jymc) as jymc,
	cxkh,
	max(jyzjhm) as jyzjhm,
	max(jyrq) as jyrq,
	sum(jyje) as jyzje,
	count(1) as jyzbs,
	SUM(case JDBZ when '出' then JYJE else 0 end) as CZJE,
	SUM(case JDBZ when '出' then 1 else 0 end) as CZBS,
	SUM(case JDBZ when '进' then JYJE else 0 end) as JZJE,
	SUM(case JDBZ when '进' then 1 else 0 end) as JZBS,
	SUM(case JDBZ when '进' then JYJE else - JYJE end) as JCZCE
from
	mz_bank_records
where
	ajid = 1447663931
	and cxkh is not null
group by
	cxkh
having
	sum(jyje) >= 1000000
	and count(1) >= 10 ;

```

##### 输出字段：

序号（++），交易卡号（cxkh），交易名称（jymc），交易证件号码（jyzjhm），交易总金额（jyzje），交易总笔数(jyzbs)，进账金额(jzje)，进账笔数(jzbs)，出账金额(czje)，出账笔数(czbs)，进出帐差额(jczce)

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cmoca64gj31vm09atee.jpg)

#### 2. 过渡账户发现

> 交易金额、交易时间符合A -> B -> C行为的中间账号
>
> 说白了就是找出在一定的交易时间内，发生了进账金额接近出账金额的账户
>
> 统计结果：交易卡号，交易名称，过渡进账总金额，过渡进账总笔数。
>
> 
>
> 求取交易金额交易时间符合A-B-C行为的中间账号， 其中过渡交易总金额=符合要求的进账金额， 过渡交易总次数=符合要求的进账次数， 权重=符合条件的进账有几笔/该账号总共进账有几笔

```sql
/*求取交易金额交易时间符合A-B-C行为的中间账号，
 其中过渡交易总金额=符合要求的进账金额，
 过渡交易总次数=符合要求的进账次数，
 权重=符合条件的进账有几笔/该账号总共进账有几笔*/
 with 
 /*T1读取出符合条件的A-B-C*/
T1 as(
select
	A.JYDFZKH ACXKH,
	A.JYDFMC as AJYMC,
	A.JYSJ as AJYSJ,
	A.JYJE as AJYJE,
	A.CXKH as BCXKH,
	A.jymc as BJYMC,
	B.JYSJ as BJYRQ,
	B.JYJE as BJYJE,
	B.JYDFZKH as CCXKH,
	B.JYDFMC as CJYMC
from
	(
	select
		distinct CXKH,
		JYMC,
		JYSJ,
		JYJE,
		JDBZ,
		JYDFZKH,
		JYDFMC
	from
		mz_bank_records
	where
		JDBZ = '进'
		and AJID = 1447663931
		and JYJE >= 10000 ) A
join       
 (
	select
		distinct CXKH,
		JYMC,
		JYSJ,
		JYJE,
		JDBZ,
		JYDFZKH,
		JYDFMC
	from
		mz_bank_records
	where
		JDBZ = '出'
		and AJID = 1447663931
		and JYJE >= 10000 ) B         
 on
	A.CXKH = B.CXKH
	and B.JYSJ::TIMESTAMP between A.JYSJ::TIMESTAMP and A.JYSJ::TIMESTAMP + '24 hour'
	and B.JYJE between A.JYJE * 0.9 and A.JYJE * 1.1
 ),
 /*对A方B方相同的数据进行去重*/
T2 as (
select
	distinct ACXKH,
	BCXKH as CXKH,
	BJYMC as JYMC,
	AJYSJ as JYSJ,
	AJYJE as JYJE
from
	T1 ),
 /*对符合要求的过度账号进行汇总计算过渡总金额，过渡总笔数*/
T3 as 
 (
select
	CXKH,
	MAX(JYMC) as JYMC,
	SUM(JYJE) as JYZJE,
	COUNT(JYJE) as JYZBS
from
	T2
group by
	CXKH,
	JYMC),
 /*汇总获取所有账号的进总笔数，用于计算权重*/
T4 as (
select
	CXKH,
	JYMC,
	COUNT(JYJE) as JYZBS
from
	mz_bank_records
where
	JDBZ = '进'
	and AJID = 1447663931
	and JYJE >= 10000
group by
	CXKH,
	JYMC),
 /*左连接计算权重=符合条件的进账有几笔/该账号总共进账有几笔*/
T5 as(
select
	T3.CXKH as GDZH,
	T3.JYMC as GDHM,
	T3.JYZJE as GDJYZJE,
	T3.JYZBS as GDJYZBS,
	T4.JYZBS as JJYZBS,
	ROUND( T3.JYZBS :: numeric / T4.JYZBS :: numeric * 100, 4 ) as QZ
from
	T3
left join T4 on
	T3.CXKH = T4.CXKH
	and T3.JYMC = T4.JYMC)
 select
	*
from
	T5
where
	QZ >= 10
	and GDJYZBS >= 5
	and JJYZBS >= 50
order by
	GDJYZBS desc
```

##### 输出字段：

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cmpooir2j31hg06qwh8.jpg)

#### 3. 重点对手账户发现

> 统计所有交易方账户关联的对手账户的交易金额和交易笔数。
>
> 旨在发现交易行为中，交易金额、交易次数超过某一阈值发现模型，着重突出的是对手方。
>
> 统计结果：交易卡号，交易名称，交易证件号码，对手账号，对手名称，交易总金额，交易总笔数，进账金额，进账笔数，出账金额，出账笔数，进出帐差额。

```sql
(
select
	*
from
	(
	select
		ARRAY_TO_STRING(ICAP_BASE.GROUP_CONCAT(case when (JDBZ = '出' and CXKH >= JYDFZKH) or (JDBZ = '进' and CXKH < JYDFZKH) then SHARD_ID end), ',')as CIDS,
		ARRAY_TO_STRING(ICAP_BASE.GROUP_CONCAT(case when (JDBZ = '进' and CXKH >= JYDFZKH) or (JDBZ = '出' and CXKH < JYDFZKH) then SHARD_ID end), ',')as JIDS,
		case
			when CXKH >= JYDFZKH then CXKH || JYDFZKH
			else JYDFZKH || CXKH
		end as FLAG,
		MAX(CXKH) as CXKH,
		MAX(case when CXKH >= JYDFZKH then JYMC else JYDFMC end) as JYMC,
		MAX(case when CXKH >= JYDFZKH then JYZJHM else JYDFZJHM end) as JYZJHM,
		MIN(JYDFZKH) as JYDFZKH,
		MAX(case when CXKH >= JYDFZKH then JYDFMC else JYMC end) as JYDFMC,
		MAX(case when CXKH >= JYDFZKH then JYDFZJHM else JYZJHM end) as JYDFZJHM,
		SUM( case when JYJE is null then 0 else JYJE end ) as JYZJE ,
		COUNT(1) as JYZBS ,
		SUM(case when (JDBZ = '出' and CXKH >= JYDFZKH) or (JDBZ = '进' and CXKH < JYDFZKH) then JYJE else 0 end) as CZJE ,
		SUM(case when (JDBZ = '出' and CXKH >= JYDFZKH) or (JDBZ = '进' and CXKH < JYDFZKH) then 1 else 0 end) as CZBS ,
		SUM(case when (JDBZ = '进' and CXKH >= JYDFZKH) or (JDBZ = '出' and CXKH < JYDFZKH) then JYJE else 0 end) as JZJE,
		SUM(case when (JDBZ = '进' and CXKH >= JYDFZKH) or (JDBZ = '出' and CXKH < JYDFZKH) then 1 else 0 end) as JZBS,
		SUM(case when (JDBZ = '进' and CXKH >= JYDFZKH) or (JDBZ = '出' and CXKH < JYDFZKH) then JYJE else -JYJE end) as JCZCE,
		MIN(JYSJ) as ZZJYRQ,
		MAX(JYSJ) as ZWJYRQ,
		MAX(JDBZ) as JDBZ,
		MAX(JYDFZKH) as MAXJYDFZKH
	from
		mz_bank_records
	where
		AJID = 1447663931
		and CXKH is not null
		and JYDFZKH is not null
		and (LENGTH( coalesce(CXKH, '0'))>0)
		and (LENGTH( coalesce(JYDFZKH, '0'))>0)
	group by
		FLAG

  ) J
where
	CXKH = MAXJYDFZKH
	and JYZJE >= 1000000
	and JYZBS >= 10 )
union all 
 (
select
*
from
(
select
	ARRAY_TO_STRING(ICAP_BASE.GROUP_CONCAT(case when JDBZ = '出' then SHARD_ID end), ',')as CIDS,
	ARRAY_TO_STRING(ICAP_BASE.GROUP_CONCAT(case when JDBZ = '进' then SHARD_ID end), ',')as JIDS,
	case
		when CXKH >= JYDFZKH then CXKH || JYDFZKH
		else JYDFZKH || CXKH
	end as FLAG,
	MAX(CXKH) as CXKH,
	MAX(JYMC) as JYMC,
	MAX(JYZJHM) as JYZJHM,
	MAX(JYDFZKH) as JYDFZKH,
	MAX(JYDFMC) as JYDFMC,
	MAX(JYDFZJHM) as JYDFZJHM,
	SUM(case when JYJE is null then 0 else JYJE end) as JYZJE ,
	COUNT(1) as JYZBS ,
	SUM(case when (JDBZ = '出' ) then JYJE else 0 end) as CZJE ,
	SUM(case when (JDBZ = '出' ) then 1 else 0 end) as CZBS ,
	SUM(case when (JDBZ = '进' ) then JYJE else 0 end) as JZJE,
	SUM(case when (JDBZ = '进' ) then 1 else 0 end) as JZBS,
	SUM(case when (JDBZ = '进' ) then JYJE else -JYJE end) as JCZCE,
	MIN(JYSJ) as ZZJYRQ,
	MAX(JYSJ) as ZWJYRQ,
	MAX(JDBZ) as JDBZ,
	MAX(JYDFZKH) as MAXJYDFZKH
from
	mz_bank_records
where
	AJID = 1447663931
	and CXKH is not null
	and JYDFZKH is not null
	and (LENGTH( coalesce(CXKH, '0'))>0)
		and (LENGTH( coalesce(JYDFZKH, '0'))>0)
	group by
		FLAG

  ) J
where
CXKH != MAXJYDFZKH
and JYZJE >= 1000000
and JYZBS >= 10 )
order by
JYZBS desc
```

##### 输出字段：

输出：序号(++)，交易卡号(cxkh)，交易名称(jymc)，交易证件号码(jyzjhm)，对手账号(jydfzkh)，对手名称(jydfmc)，对手身份证号(jydfzjhm)，交易总金额(jyzje)，交易总笔数(jyzbs)，出账金额(czje)，出账笔数(czbs)，进账金额(jzje)，进账笔数(jzbs)，进出帐差额(jczce)，最早交易日期(zzjyrq)，最晚交易日期(zwjyrq)

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cmqmrjgoj31w010wwzz.jpg)

#### 4.重点对手户名发现（户名可以通过数据补全）

> 统计所有交易方户名关联的对手户名的交易金额和交易笔数。
>
> 旨在发现交易行为中，交易金额、交易次数超过某一阈值发现模型，着重突出的是对手方。
>
> 统计结果：交易户名。。。

```sql
(SELECT * FROM(

  SELECT 

  ARRAY_TO_STRING(ICAP_BASE.GROUP_CONCAT(CASE WHEN (JDBZ ='出' AND JYMC >= JYDFMC) OR (JDBZ ='进' AND JYMC < JYDFMC) THEN SHARD_ID END), ',')AS CIDS,

  ARRAY_TO_STRING(ICAP_BASE.GROUP_CONCAT(CASE WHEN (JDBZ ='进' AND JYMC >= JYDFMC) OR (JDBZ ='出' AND JYMC < JYDFMC) THEN SHARD_ID END), ',')AS JIDS,

  CASE WHEN JYMC >= JYDFMC then JYMC||JYDFMC else JYDFMC||JYMC end as FLAG,

  MAX(JYMC) AS JYMC,

  MAX(CASE WHEN JYMC >= JYDFMC then JYZJHM else JYDFZJHM end) AS JYZJHM,

  MIN(JYDFMC) AS JYDFMC,

  MAX(CASE WHEN JYMC >= JYDFMC then JYDFZJHM else JYZJHM end) AS JYDFZJHM,

  SUM( CASE WHEN JYJE IS NULL THEN 0 ELSE JYJE END ) AS JYZJE ,

  COUNT(1) AS JYZBS ,

  SUM( CASE WHEN (JDBZ ='出' AND JYMC >= JYDFMC) OR (JDBZ ='进' AND JYMC < JYDFMC) THEN JYJE ELSE 0 END ) AS CZJE,

  SUM( CASE WHEN (JDBZ ='出' AND JYMC >= JYDFMC) OR (JDBZ ='进' AND JYMC < JYDFMC) THEN 1 ELSE 0 END ) AS CZBS,

  SUM( CASE WHEN (JDBZ ='进' AND JYMC >= JYDFMC) OR (JDBZ ='出' AND JYMC < JYDFMC) THEN JYJE ELSE 0 END ) AS JZJE,

  SUM( CASE WHEN (JDBZ ='进' AND JYMC >= JYDFMC) OR (JDBZ ='出' AND JYMC < JYDFMC) THEN 1 ELSE 0 END ) AS JZBS,

  SUM( CASE WHEN (JDBZ ='进' AND JYMC >= JYDFMC) OR (JDBZ ='出' AND JYMC < JYDFMC) THEN JYJE ELSE - JYJE END ) AS JCZCE,

  MIN(JYSJ) AS ZZJYRQ,

  MAX(JYSJ) AS ZWJYRQ,

  MAX(JDBZ) AS JDBZ,

  MAX(JYDFMC) as MAXJYDFMC

  FROM 

  mz_bank_records



  WHERE AJID = 990675050   AND JYMC IS NOT NULL AND JYDFMC IS NOT NULL AND ( LENGTH( COALESCE ( JYMC, '0' ) ) > 0 ) AND ( LENGTH( COALESCE ( JYDFMC, '0' ) ) > 0 ) 

  GROUP BY FLAG

) J WHERE JYMC = MAXJYDFMC and JYZJE >= 1000000 AND JYZBS >= 10  ) 

 UNION ALL

 (SELECT * FROM(

   SELECT 
   ARRAY_TO_STRING(ICAP_BASE.GROUP_CONCAT(CASE WHEN JDBZ ='出' THEN SHARD_ID END), ',')AS CIDS,

   ARRAY_TO_STRING(ICAP_BASE.GROUP_CONCAT(CASE WHEN JDBZ ='进' THEN SHARD_ID END), ',')AS JIDS,

   CASE WHEN JYMC >= JYDFMC then JYMC||JYDFMC else JYDFMC||JYMC end as FLAG,

   MAX(JYMC) AS JYMC,

   MAX(JYZJHM) AS JYZJHM,

   MAX(JYDFMC) AS JYDFMC,
   MAX(JYDFZJHM) AS JYDFZJHM,
   SUM( CASE WHEN JYJE IS NULL THEN 0 ELSE JYJE END ) AS JYZJE ,
   COUNT(1) AS JYZBS ,
   SUM(CASE WHEN (JDBZ ='出' ) THEN JYJE ELSE 0 END) AS CZJE, 
   SUM(CASE WHEN (JDBZ ='出' ) THEN 1 ELSE 0 END) AS CZBS, 
   SUM(CASE WHEN (JDBZ ='进' ) THEN JYJE ELSE 0 END) AS JZJE, 
   SUM(CASE WHEN (JDBZ ='进' ) THEN 1 ELSE 0 END) AS JZBS, 
   SUM(CASE WHEN (JDBZ ='进' ) THEN JYJE ELSE - JYJE END) AS JCZCE, 
   MIN(JYSJ) AS ZZJYRQ,
   MAX(JYSJ) AS ZWJYRQ,
   MAX(JDBZ) AS JDBZ,
   MAX(JYDFMC) as MAXJYDFMC
   FROM 
   mz_bank_records

   WHERE AJID = 990675050   AND JYMC IS NOT NULL AND JYDFMC IS NOT NULL AND ( LENGTH( COALESCE ( JYMC, '0' ) ) > 0 ) AND ( LENGTH( COALESCE ( JYDFMC, '0' ) ) > 0 ) 

   GROUP BY FLAG

 ) J WHERE JYMC != MAXJYDFMC  and JYZJE >= 1000000 AND JYZBS >= 10  ) ORDER BY JYZBS DESC 

```

##### 输出字段：

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2ev3ponjej31v60l2qeb.jpg)

### 二、团伙交易行为发现模型[已经被标记为某团伙，存在与mark_group_detail表中]

#### 1. 大额交易行为团伙账户发现

```sql
SELECT DISTINCT
	t1.CXKHGROUP,
	t1.jyzje,
	t1.jyzbs,
	t1.CZJE,
	t1.CZBS,
	t1.JZJE,
	t1.JZBS,
	t1.JCZCE
FROM
	(
    SELECT
    CXKHGROUP,
    max( jyrq ) AS jyrq,
    sum( jyje ) AS jyzje,
    count( 1 ) AS jyzbs,
    SUM(CASE JDBZ WHEN '出' THEN JYJE ELSE 0 END) AS CZJE, 
    SUM(CASE JDBZ WHEN '出' THEN 1 ELSE 0 END) AS CZBS, 
    SUM(CASE JDBZ WHEN '进' THEN JYJE ELSE 0 END) AS JZJE, 
    SUM(CASE JDBZ WHEN '进' THEN 1 ELSE 0 END) AS JZBS, 
    SUM(CASE JDBZ WHEN '进' THEN JYJE ELSE - JYJE END) AS JCZCE
    FROM
    (SELECT *, (CASE WHEN CXKHGROUPNAME IS NULL THEN CXKH ELSE CXKHGROUPNAME END) AS CXKHGROUP,  (CASE WHEN JYDFZKHGROUPNAME IS NULL THEN JYDFZKH ELSE JYDFZKHGROUPNAME END) AS JYDFZKHGROUP,  (CASE WHEN JYZJHMGROUPNAME IS NULL THEN JYZJHM ELSE JYZJHMGROUPNAME END) AS JYZJHMGROUP,  (CASE WHEN JYDFZJHMGROUPNAME IS NULL THEN JYDFZJHM ELSE JYDFZJHMGROUPNAME END) AS JYDFZJHMGROUP,  (CASE WHEN JYMCGROUPNAME IS NULL THEN JYMC ELSE JYMCGROUPNAME END) AS JYMCGROUP,  (CASE WHEN JYDFMCGROUPNAME IS NULL THEN JYDFMC ELSE JYDFMCGROUPNAME END) AS JYDFMCGROUP  FROM( (SELECT * FROM mz_bank_records WHERE AJID = 1447663931)BANK  LEFT JOIN(SELECT GROUPNAME AS CXKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP1 ON BANK.CXKH = GROUP1.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP2 ON BANK.JYDFZKH = GROUP2.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP3 ON BANK.JYZJHM = GROUP3.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP4 ON BANK.JYDFZJHM = GROUP4.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP5 ON BANK.JYMC = GROUP5.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP6 ON BANK.JYDFMC = GROUP6.GROUPMEMBER) ALLBANK)GROUPBANKTABLE
    WHERE
    ajid = 1447663931  
    AND CXKHGROUP IS NOT NULL AND (LENGTH( COALESCE(CXKHGROUP, '0'))>0)
    GROUP BY
    CXKHGROUP 
    HAVING
    sum( jyje ) >= 1000000 
    AND count( 1 ) >= 10 
  ) t1 

WHERE 1=1   ORDER BY jyzje DESC
```

#### 2. 过渡团伙账户发现

##### 主体名称

```sql
 /*求取交易金额交易时间符合A-B-C行为的中间账号，
 其中过渡交易总金额=符合要求的进账金额，
 过渡交易总次数=符合要求的进账次数，
 权重=符合条件的进账有几笔/该账号总共进账有几笔*/
 with 
 /*T1读取出符合条件的A-B-C*/
 T1 AS(
   SELECT
   A.JYDFMCGROUP AS ATH,
   A.JYSJ AS AJYSJ,
   A.JYJE AS AJYJE,
   A.JYMCGROUP AS BTH,
   B.JYSJ AS BJYRQ,
   B.JYJE AS BJYJE,
   B.JYDFMCGROUP AS CTH
   FROM
   (SELECT DISTINCT JYMCGROUP,JYSJ,JYJE,JDBZ,JYDFMCGROUP FROM (SELECT *, (CASE WHEN CXKHGROUPNAME IS NULL THEN CXKH ELSE CXKHGROUPNAME END) AS CXKHGROUP,  (CASE WHEN JYDFZKHGROUPNAME IS NULL THEN JYDFZKH ELSE JYDFZKHGROUPNAME END) AS JYDFZKHGROUP,  (CASE WHEN JYZJHMGROUPNAME IS NULL THEN JYZJHM ELSE JYZJHMGROUPNAME END) AS JYZJHMGROUP,  (CASE WHEN JYDFZJHMGROUPNAME IS NULL THEN JYDFZJHM ELSE JYDFZJHMGROUPNAME END) AS JYDFZJHMGROUP,  (CASE WHEN JYMCGROUPNAME IS NULL THEN JYMC ELSE JYMCGROUPNAME END) AS JYMCGROUP,  (CASE WHEN JYDFMCGROUPNAME IS NULL THEN JYDFMC ELSE JYDFMCGROUPNAME END) AS JYDFMCGROUP  FROM( (SELECT * FROM mz_bank_records WHERE AJID = 1447663931)BANK  LEFT JOIN(SELECT GROUPNAME AS CXKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP1 ON BANK.CXKH = GROUP1.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP2 ON BANK.JYDFZKH = GROUP2.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP3 ON BANK.JYZJHM = GROUP3.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP4 ON BANK.JYDFZJHM = GROUP4.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP5 ON BANK.JYMC = GROUP5.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP6 ON BANK.JYDFMC = GROUP6.GROUPMEMBER) ALLBANK)GROUPBANKTABLE 
    WHERE JDBZ='进' and AJID=1447663931 and JYJE>=10000  ) A         
   JOIN       
   (SELECT DISTINCT JYMCGROUP,JYSJ,JYJE,JDBZ,JYDFMCGROUP FROM (SELECT *, (CASE WHEN CXKHGROUPNAME IS NULL THEN CXKH ELSE CXKHGROUPNAME END) AS CXKHGROUP,  (CASE WHEN JYDFZKHGROUPNAME IS NULL THEN JYDFZKH ELSE JYDFZKHGROUPNAME END) AS JYDFZKHGROUP,  (CASE WHEN JYZJHMGROUPNAME IS NULL THEN JYZJHM ELSE JYZJHMGROUPNAME END) AS JYZJHMGROUP,  (CASE WHEN JYDFZJHMGROUPNAME IS NULL THEN JYDFZJHM ELSE JYDFZJHMGROUPNAME END) AS JYDFZJHMGROUP,  (CASE WHEN JYMCGROUPNAME IS NULL THEN JYMC ELSE JYMCGROUPNAME END) AS JYMCGROUP,  (CASE WHEN JYDFMCGROUPNAME IS NULL THEN JYDFMC ELSE JYDFMCGROUPNAME END) AS JYDFMCGROUP  FROM( (SELECT * FROM mz_bank_records WHERE AJID = 1447663931)BANK  LEFT JOIN(SELECT GROUPNAME AS CXKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP1 ON BANK.CXKH = GROUP1.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP2 ON BANK.JYDFZKH = GROUP2.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP3 ON BANK.JYZJHM = GROUP3.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP4 ON BANK.JYDFZJHM = GROUP4.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP5 ON BANK.JYMC = GROUP5.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP6 ON BANK.JYDFMC = GROUP6.GROUPMEMBER) ALLBANK)GROUPBANKTABLE 
    WHERE JDBZ='出' and AJID=1447663931 and  JYJE>=10000  ) B         
   ON A.JYMCGROUP=B.JYMCGROUP AND B.JYSJ::TIMESTAMP BETWEEN A.JYSJ::TIMESTAMP AND A.JYSJ::TIMESTAMP+'24 hour'
   and B.JYJE BETWEEN A.JYJE*0.9 AND A.JYJE*1.1
 ),
 /*对A方B方相同的数据进行去重*/
 T2 AS (SELECT DISTINCT ATH, BTH AS GDTH,AJYSJ AS JYSJ,AJYJE AS JYJE FROM T1 ),
 /*对符合要求的过度账号进行汇总计算过渡总金额，过渡总笔数*/
 T3 AS 
 (SELECT
  GDTH,
  SUM(JYJE) AS JYZJE,
  COUNT(JYJE) AS JYZBS
  FROM
  T2 
  GROUP BY
  GDTH),
 /*汇总获取所有账号的进总笔数，用于计算权重*/
 T4 AS (SELECT JYMCGROUP AS TH,COUNT(JYJE) AS JYZBS FROM 
        (SELECT *, (CASE WHEN CXKHGROUPNAME IS NULL THEN CXKH ELSE CXKHGROUPNAME END) AS CXKHGROUP,  (CASE WHEN JYDFZKHGROUPNAME IS NULL THEN JYDFZKH ELSE JYDFZKHGROUPNAME END) AS JYDFZKHGROUP,  (CASE WHEN JYZJHMGROUPNAME IS NULL THEN JYZJHM ELSE JYZJHMGROUPNAME END) AS JYZJHMGROUP,  (CASE WHEN JYDFZJHMGROUPNAME IS NULL THEN JYDFZJHM ELSE JYDFZJHMGROUPNAME END) AS JYDFZJHMGROUP,  (CASE WHEN JYMCGROUPNAME IS NULL THEN JYMC ELSE JYMCGROUPNAME END) AS JYMCGROUP,  (CASE WHEN JYDFMCGROUPNAME IS NULL THEN JYDFMC ELSE JYDFMCGROUPNAME END) AS JYDFMCGROUP  FROM( (SELECT * FROM mz_bank_records WHERE AJID = 1447663931)BANK  LEFT JOIN(SELECT GROUPNAME AS CXKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP1 ON BANK.CXKH = GROUP1.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP2 ON BANK.JYDFZKH = GROUP2.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP3 ON BANK.JYZJHM = GROUP3.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP4 ON BANK.JYDFZJHM = GROUP4.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP5 ON BANK.JYMC = GROUP5.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP6 ON BANK.JYDFMC = GROUP6.GROUPMEMBER) ALLBANK)GROUPBANKTABLE 
        WHERE JDBZ='进' and AJID=1447663931 AND JYJE>=10000   GROUP BY JYMCGROUP),
 /*左连接计算权重=符合条件的进账有几笔/该账号总共进账有几笔*/
 T5 AS(
   SELECT
   T3.GDTH AS GDTH,
   T3.JYZJE AS GDJYZJE,
   T3.JYZBS AS GDJYZBS,
   T4.JYZBS AS JJYZBS,
   ROUND( T3.JYZBS :: NUMERIC / T4.JYZBS :: NUMERIC * 100, 4 ) AS QZ
   FROM T3 LEFT JOIN T4 ON T3.GDTH=T4.TH)
 SELECT * FROM T5 WHERE QZ>=10 AND GDJYZBS>=5 AND JJYZBS>=50  ORDER BY GDJYZBS DESC
```

##### 证件号码

```sql
/*求取交易金额交易时间符合A-B-C行为的中间账号，
 其中过渡交易总金额=符合要求的进账金额，
 过渡交易总次数=符合要求的进账次数，
 权重=符合条件的进账有几笔/该账号总共进账有几笔*/
 with 
 /*T1读取出符合条件的A-B-C*/
 T1 AS(
   SELECT
   A.JYDFZJHMGROUP AS ATH,
   A.JYSJ AS AJYSJ,
   A.JYJE AS AJYJE,
   A.JYZJHMGROUP AS BTH,
   B.JYSJ AS BJYRQ,
   B.JYJE AS BJYJE,
   B.JYDFZJHMGROUP AS CTH
   FROM
   (SELECT DISTINCT JYZJHMGROUP,JYSJ,JYJE,JDBZ,JYDFZJHMGROUP FROM (SELECT *, (CASE WHEN CXKHGROUPNAME IS NULL THEN CXKH ELSE CXKHGROUPNAME END) AS CXKHGROUP,  (CASE WHEN JYDFZKHGROUPNAME IS NULL THEN JYDFZKH ELSE JYDFZKHGROUPNAME END) AS JYDFZKHGROUP,  (CASE WHEN JYZJHMGROUPNAME IS NULL THEN JYZJHM ELSE JYZJHMGROUPNAME END) AS JYZJHMGROUP,  (CASE WHEN JYDFZJHMGROUPNAME IS NULL THEN JYDFZJHM ELSE JYDFZJHMGROUPNAME END) AS JYDFZJHMGROUP,  (CASE WHEN JYMCGROUPNAME IS NULL THEN JYMC ELSE JYMCGROUPNAME END) AS JYMCGROUP,  (CASE WHEN JYDFMCGROUPNAME IS NULL THEN JYDFMC ELSE JYDFMCGROUPNAME END) AS JYDFMCGROUP  FROM( (SELECT * FROM mz_bank_records WHERE AJID = 1447663931)BANK  LEFT JOIN(SELECT GROUPNAME AS CXKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP1 ON BANK.CXKH = GROUP1.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP2 ON BANK.JYDFZKH = GROUP2.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP3 ON BANK.JYZJHM = GROUP3.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP4 ON BANK.JYDFZJHM = GROUP4.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP5 ON BANK.JYMC = GROUP5.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP6 ON BANK.JYDFMC = GROUP6.GROUPMEMBER) ALLBANK)GROUPBANKTABLE 
    WHERE JDBZ='进' and AJID=1447663931 and JYJE>=10000  ) A         
   JOIN       
   (SELECT DISTINCT JYZJHMGROUP,JYSJ,JYJE,JDBZ,JYDFZJHMGROUP FROM (SELECT *, (CASE WHEN CXKHGROUPNAME IS NULL THEN CXKH ELSE CXKHGROUPNAME END) AS CXKHGROUP,  (CASE WHEN JYDFZKHGROUPNAME IS NULL THEN JYDFZKH ELSE JYDFZKHGROUPNAME END) AS JYDFZKHGROUP,  (CASE WHEN JYZJHMGROUPNAME IS NULL THEN JYZJHM ELSE JYZJHMGROUPNAME END) AS JYZJHMGROUP,  (CASE WHEN JYDFZJHMGROUPNAME IS NULL THEN JYDFZJHM ELSE JYDFZJHMGROUPNAME END) AS JYDFZJHMGROUP,  (CASE WHEN JYMCGROUPNAME IS NULL THEN JYMC ELSE JYMCGROUPNAME END) AS JYMCGROUP,  (CASE WHEN JYDFMCGROUPNAME IS NULL THEN JYDFMC ELSE JYDFMCGROUPNAME END) AS JYDFMCGROUP  FROM( (SELECT * FROM mz_bank_records WHERE AJID = 1447663931)BANK  LEFT JOIN(SELECT GROUPNAME AS CXKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP1 ON BANK.CXKH = GROUP1.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP2 ON BANK.JYDFZKH = GROUP2.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP3 ON BANK.JYZJHM = GROUP3.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP4 ON BANK.JYDFZJHM = GROUP4.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP5 ON BANK.JYMC = GROUP5.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP6 ON BANK.JYDFMC = GROUP6.GROUPMEMBER) ALLBANK)GROUPBANKTABLE 
    WHERE JDBZ='出' and AJID=1447663931 and  JYJE>=10000  ) B         
   ON A.JYZJHMGROUP=B.JYZJHMGROUP AND B.JYSJ::TIMESTAMP BETWEEN A.JYSJ::TIMESTAMP AND A.JYSJ::TIMESTAMP+'24 hour'
   and B.JYJE BETWEEN A.JYJE*0.9 AND A.JYJE*1.1
 ),
 /*对A方B方相同的数据进行去重*/
 T2 AS (SELECT DISTINCT ATH, BTH AS GDTH,AJYSJ AS JYSJ,AJYJE AS JYJE FROM T1 ),
 /*对符合要求的过度账号进行汇总计算过渡总金额，过渡总笔数*/
 T3 AS 
 (SELECT
  GDTH,
  SUM(JYJE) AS JYZJE,
  COUNT(JYJE) AS JYZBS
  FROM
  T2 
  GROUP BY
  GDTH),
 /*汇总获取所有账号的进总笔数，用于计算权重*/
 T4 AS (SELECT JYZJHMGROUP AS TH,COUNT(JYJE) AS JYZBS FROM 
        (SELECT *, (CASE WHEN CXKHGROUPNAME IS NULL THEN CXKH ELSE CXKHGROUPNAME END) AS CXKHGROUP,  (CASE WHEN JYDFZKHGROUPNAME IS NULL THEN JYDFZKH ELSE JYDFZKHGROUPNAME END) AS JYDFZKHGROUP,  (CASE WHEN JYZJHMGROUPNAME IS NULL THEN JYZJHM ELSE JYZJHMGROUPNAME END) AS JYZJHMGROUP,  (CASE WHEN JYDFZJHMGROUPNAME IS NULL THEN JYDFZJHM ELSE JYDFZJHMGROUPNAME END) AS JYDFZJHMGROUP,  (CASE WHEN JYMCGROUPNAME IS NULL THEN JYMC ELSE JYMCGROUPNAME END) AS JYMCGROUP,  (CASE WHEN JYDFMCGROUPNAME IS NULL THEN JYDFMC ELSE JYDFMCGROUPNAME END) AS JYDFMCGROUP  FROM( (SELECT * FROM mz_bank_records WHERE AJID = 1447663931)BANK  LEFT JOIN(SELECT GROUPNAME AS CXKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP1 ON BANK.CXKH = GROUP1.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP2 ON BANK.JYDFZKH = GROUP2.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP3 ON BANK.JYZJHM = GROUP3.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP4 ON BANK.JYDFZJHM = GROUP4.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP5 ON BANK.JYMC = GROUP5.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP6 ON BANK.JYDFMC = GROUP6.GROUPMEMBER) ALLBANK)GROUPBANKTABLE 
        WHERE JDBZ='进' and AJID=1447663931 AND JYJE>=10000   GROUP BY JYZJHMGROUP),
 /*左连接计算权重=符合条件的进账有几笔/该账号总共进账有几笔*/
 T5 AS(
   SELECT
   T3.GDTH AS GDTH,
   T3.JYZJE AS GDJYZJE,
   T3.JYZBS AS GDJYZBS,
   T4.JYZBS AS JJYZBS,
   ROUND( T3.JYZBS :: NUMERIC / T4.JYZBS :: NUMERIC * 100, 4 ) AS QZ
   FROM T3 LEFT JOIN T4 ON T3.GDTH=T4.TH)
 SELECT * FROM T5 WHERE QZ>=10 AND GDJYZBS>=5 AND JJYZBS>=50  ORDER BY GDJYZBS DESC
```

##### 账号、卡号

```sql
 /*求取交易金额交易时间符合A-B-C行为的中间账号，
 其中过渡交易总金额=符合要求的进账金额，
 过渡交易总次数=符合要求的进账次数，
 权重=符合条件的进账有几笔/该账号总共进账有几笔*/
 with 
 /*T1读取出符合条件的A-B-C*/
 T1 AS(
   SELECT
   A.JYDFZKHGROUP AS ATH,
   A.JYSJ AS AJYSJ,
   A.JYJE AS AJYJE,
   A.CXKHGROUP AS BTH,
   B.JYSJ AS BJYRQ,
   B.JYJE AS BJYJE,
   B.JYDFZKHGROUP AS CTH
   FROM
   (SELECT DISTINCT CXKHGROUP,JYSJ,JYJE,JDBZ,JYDFZKHGROUP FROM (SELECT *, (CASE WHEN CXKHGROUPNAME IS NULL THEN CXKH ELSE CXKHGROUPNAME END) AS CXKHGROUP,  (CASE WHEN JYDFZKHGROUPNAME IS NULL THEN JYDFZKH ELSE JYDFZKHGROUPNAME END) AS JYDFZKHGROUP,  (CASE WHEN JYZJHMGROUPNAME IS NULL THEN JYZJHM ELSE JYZJHMGROUPNAME END) AS JYZJHMGROUP,  (CASE WHEN JYDFZJHMGROUPNAME IS NULL THEN JYDFZJHM ELSE JYDFZJHMGROUPNAME END) AS JYDFZJHMGROUP,  (CASE WHEN JYMCGROUPNAME IS NULL THEN JYMC ELSE JYMCGROUPNAME END) AS JYMCGROUP,  (CASE WHEN JYDFMCGROUPNAME IS NULL THEN JYDFMC ELSE JYDFMCGROUPNAME END) AS JYDFMCGROUP  FROM( (SELECT * FROM mz_bank_records WHERE AJID = 1447663931)BANK  LEFT JOIN(SELECT GROUPNAME AS CXKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP1 ON BANK.CXKH = GROUP1.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP2 ON BANK.JYDFZKH = GROUP2.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP3 ON BANK.JYZJHM = GROUP3.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP4 ON BANK.JYDFZJHM = GROUP4.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP5 ON BANK.JYMC = GROUP5.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP6 ON BANK.JYDFMC = GROUP6.GROUPMEMBER) ALLBANK)GROUPBANKTABLE 
    WHERE JDBZ='进' and AJID=1447663931 and JYJE>=10000  ) A         
   JOIN       
   (SELECT DISTINCT CXKHGROUP,JYSJ,JYJE,JDBZ,JYDFZKHGROUP FROM (SELECT *, (CASE WHEN CXKHGROUPNAME IS NULL THEN CXKH ELSE CXKHGROUPNAME END) AS CXKHGROUP,  (CASE WHEN JYDFZKHGROUPNAME IS NULL THEN JYDFZKH ELSE JYDFZKHGROUPNAME END) AS JYDFZKHGROUP,  (CASE WHEN JYZJHMGROUPNAME IS NULL THEN JYZJHM ELSE JYZJHMGROUPNAME END) AS JYZJHMGROUP,  (CASE WHEN JYDFZJHMGROUPNAME IS NULL THEN JYDFZJHM ELSE JYDFZJHMGROUPNAME END) AS JYDFZJHMGROUP,  (CASE WHEN JYMCGROUPNAME IS NULL THEN JYMC ELSE JYMCGROUPNAME END) AS JYMCGROUP,  (CASE WHEN JYDFMCGROUPNAME IS NULL THEN JYDFMC ELSE JYDFMCGROUPNAME END) AS JYDFMCGROUP  FROM( (SELECT * FROM mz_bank_records WHERE AJID = 1447663931)BANK  LEFT JOIN(SELECT GROUPNAME AS CXKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP1 ON BANK.CXKH = GROUP1.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP2 ON BANK.JYDFZKH = GROUP2.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP3 ON BANK.JYZJHM = GROUP3.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP4 ON BANK.JYDFZJHM = GROUP4.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP5 ON BANK.JYMC = GROUP5.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP6 ON BANK.JYDFMC = GROUP6.GROUPMEMBER) ALLBANK)GROUPBANKTABLE 
    WHERE JDBZ='出' and AJID=1447663931 and  JYJE>=10000  ) B         
   ON A.CXKHGROUP=B.CXKHGROUP AND B.JYSJ::TIMESTAMP BETWEEN A.JYSJ::TIMESTAMP AND A.JYSJ::TIMESTAMP+'24 hour'
   and B.JYJE BETWEEN A.JYJE*0.9 AND A.JYJE*1.1
 ),
 /*对A方B方相同的数据进行去重*/
 T2 AS (SELECT DISTINCT ATH, BTH AS GDTH,AJYSJ AS JYSJ,AJYJE AS JYJE FROM T1 ),
 /*对符合要求的过度账号进行汇总计算过渡总金额，过渡总笔数*/
 T3 AS 
 (SELECT
  GDTH,
  SUM(JYJE) AS JYZJE,
  COUNT(JYJE) AS JYZBS
  FROM
  T2 
  GROUP BY
  GDTH),
 /*汇总获取所有账号的进总笔数，用于计算权重*/
 T4 AS (SELECT CXKHGROUP AS TH,COUNT(JYJE) AS JYZBS FROM 
        (SELECT *, (CASE WHEN CXKHGROUPNAME IS NULL THEN CXKH ELSE CXKHGROUPNAME END) AS CXKHGROUP,  (CASE WHEN JYDFZKHGROUPNAME IS NULL THEN JYDFZKH ELSE JYDFZKHGROUPNAME END) AS JYDFZKHGROUP,  (CASE WHEN JYZJHMGROUPNAME IS NULL THEN JYZJHM ELSE JYZJHMGROUPNAME END) AS JYZJHMGROUP,  (CASE WHEN JYDFZJHMGROUPNAME IS NULL THEN JYDFZJHM ELSE JYDFZJHMGROUPNAME END) AS JYDFZJHMGROUP,  (CASE WHEN JYMCGROUPNAME IS NULL THEN JYMC ELSE JYMCGROUPNAME END) AS JYMCGROUP,  (CASE WHEN JYDFMCGROUPNAME IS NULL THEN JYDFMC ELSE JYDFMCGROUPNAME END) AS JYDFMCGROUP  FROM( (SELECT * FROM mz_bank_records WHERE AJID = 1447663931)BANK  LEFT JOIN(SELECT GROUPNAME AS CXKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP1 ON BANK.CXKH = GROUP1.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZKHGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP2 ON BANK.JYDFZKH = GROUP2.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP3 ON BANK.JYZJHM = GROUP3.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZJHMGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP4 ON BANK.JYDFZJHM = GROUP4.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP5 ON BANK.JYMC = GROUP5.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFMCGROUPNAME, GROUPMEMBER FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP6 ON BANK.JYDFMC = GROUP6.GROUPMEMBER) ALLBANK)GROUPBANKTABLE 
        WHERE JDBZ='进' and AJID=1447663931 AND JYJE>=10000   GROUP BY CXKHGROUP),
 /*左连接计算权重=符合条件的进账有几笔/该账号总共进账有几笔*/
 T5 AS(
   SELECT
   T3.GDTH AS GDTH,
   T3.JYZJE AS GDJYZJE,
   T3.JYZBS AS GDJYZBS,
   T4.JYZBS AS JJYZBS,
   ROUND( T3.JYZBS :: NUMERIC / T4.JYZBS :: NUMERIC * 100, 4 ) AS QZ
   FROM T3 LEFT JOIN T4 ON T3.GDTH=T4.TH)
 SELECT * FROM T5 WHERE QZ>=10 AND GDJYZBS>=5 AND JJYZBS>=50  ORDER BY GDJYZBS DESC
```

##### 输出字段：

序号(++)，交易方户名（组）/交易方证件号（组）/交易卡号（组）(对应查询出的第一列)，发生次数(fscs)，进账金额(jzje)，出账金额(czje)

![img](file:////Users/baiyang/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image002.jpg)

#### 3. 重点交易对手团伙发现

##### 主体名称

```sql
(SELECT * FROM(

  SELECT  

  CASE WHEN JYMCGROUP >= JYDFMCGROUP then JYMCGROUP||JYDFMCGROUP else JYDFMCGROUP||JYMCGROUP end as FLAG,

  MAX(JYMCGROUP) AS JYMCGROUP,

  MIN(JYDFMCGROUP) AS JYDFMCGROUP,

  MAX(CASE WHEN JYMCGROUP >= JYDFMCGROUP then JYMCGROUPMEMBERCOUNT else JYDFMCGROUPMEMBERCOUNT end) AS JYMCGROUPMEMBERCOUNT,

  MAX(CASE WHEN JYMCGROUP >= JYDFMCGROUP then JYDFMCGROUPMEMBERCOUNT else JYMCGROUPMEMBERCOUNT end) AS JYDFMCGROUPMEMBERCOUNT,

  MAX(CASE WHEN JYMCGROUP >= JYDFMCGROUP then CXKH else JYDFZKH end) AS CXKH,

  MAX(CASE WHEN JYMCGROUP >= JYDFMCGROUP then JYMC else JYDFMC end) AS JYMC,

  MAX(CASE WHEN JYMCGROUP >= JYDFMCGROUP then JYZJHM else JYDFZJHM end) AS JYZJHM,

  MAX(CASE WHEN JYMCGROUP >= JYDFMCGROUP then JYDFZKH else CXKH end) AS JYDFZKH,

  MAX(CASE WHEN JYMCGROUP >= JYDFMCGROUP then JYDFMC else JYMC end) AS JYDFMC,

  MAX(CASE WHEN JYMCGROUP >= JYDFMCGROUP then JYDFZJHM else JYZJHM end) AS JYDFZJHM,

  SUM( CASE WHEN JYJE IS NULL THEN 0 ELSE JYJE END ) AS JYZJE ,

  COUNT(1) AS JYZBS ,

  SUM(CASE WHEN (JDBZ ='出' AND JYMCGROUP >= JYDFMCGROUP) OR (JDBZ ='进' AND JYMCGROUP < JYDFMCGROUP) THEN JYJE ELSE 0 END) AS CZJE ,

  SUM(CASE WHEN (JDBZ ='出' AND JYMCGROUP >= JYDFMCGROUP) OR (JDBZ ='进' AND JYMCGROUP < JYDFMCGROUP) THEN 1 ELSE 0 END) AS CZBS ,

  SUM(CASE WHEN (JDBZ ='进' AND JYMCGROUP >= JYDFMCGROUP) OR (JDBZ ='出' AND JYMCGROUP < JYDFMCGROUP) THEN JYJE ELSE 0 END) AS JZJE,

  SUM(CASE WHEN (JDBZ ='进' AND JYMCGROUP >= JYDFMCGROUP) OR (JDBZ ='出' AND JYMCGROUP < JYDFMCGROUP) THEN 1 ELSE 0 END) AS JZBS,

  SUM(CASE WHEN (JDBZ ='进' AND JYMCGROUP >= JYDFMCGROUP) OR (JDBZ ='出' AND JYMCGROUP < JYDFMCGROUP) THEN JYJE ELSE -JYJE END) AS JCZCE,

  MIN(JYSJ) AS ZZJYRQ,

  MAX(JYSJ) AS ZWJYRQ,

  MAX(JDBZ) AS JDBZ,

  MAX(JYDFMCGROUP) AS MAXDSGROUPNAME

  FROM 



  (  SELECT *, (CASE WHEN CXKHGROUPNAME IS NULL THEN CXKH ELSE CXKHGROUPNAME END) AS CXKHGROUP,  (CASE WHEN JYDFZKHGROUPNAME IS NULL THEN JYDFZKH ELSE JYDFZKHGROUPNAME END) AS JYDFZKHGROUP,  (CASE WHEN JYZJHMGROUPNAME IS NULL THEN JYZJHM ELSE JYZJHMGROUPNAME END) AS JYZJHMGROUP, (CASE WHEN JYDFZJHMGROUPNAME IS NULL THEN JYDFZJHM ELSE JYDFZJHMGROUPNAME END) AS JYDFZJHMGROUP,  (CASE WHEN JYMCGROUPNAME IS NULL THEN JYMC ELSE JYMCGROUPNAME END) AS JYMCGROUP,  (CASE WHEN JYDFMCGROUPNAME IS NULL THEN JYDFMC ELSE JYDFMCGROUPNAME END) AS JYDFMCGROUP  FROM(  (SELECT * FROM mz_bank_records WHERE AJID = 1447663931 )BANK  LEFT JOIN (SELECT GROUPNAME AS CXKHGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS CXKHGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP1 on BANK.CXKH = GROUP1.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZKHGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFZKHGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP2 on BANK.JYDFZKH = GROUP2.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYZJHMGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYZJHMGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP3 on BANK.JYZJHM = GROUP3.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZJHMGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFZJHMGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP4 on BANK.JYDFZJHM = GROUP4.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYMCGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYMCGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP5 on BANK.JYMC = GROUP5.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFMCGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFMCGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP6 on BANK.JYDFMC = GROUP6.GROUPMEMBER  )ALLBANK)GROUPBANKTABLE



  WHERE  AJID = 1447663931     AND JYMCGROUP IS NOT NULL AND  JYDFMCGROUP IS NOT NULL AND (LENGTH( COALESCE(JYMCGROUP, '0'))>0) AND  (LENGTH( COALESCE(JYDFMCGROUP, '0'))>0) 

  GROUP BY FLAG

)J WHERE JYMCGROUP=MAXDSGROUPNAME and JYZJE >= 1000000 AND JYZBS >= 10  )



UNION ALL



(SELECT * FROM(

  SELECT  

  CASE WHEN JYMCGROUP >= JYDFMCGROUP then JYMCGROUP||JYDFMCGROUP else JYDFMCGROUP||JYMCGROUP end as FLAG,

  MAX(JYMCGROUP) AS JYMCGROUP,

  MAX(JYDFMCGROUP) AS JYDFMCGROUP,

  MAX(JYMCGROUPMEMBERCOUNT) AS JYMCGROUPMEMBERCOUNT,

  MAX(JYDFMCGROUPMEMBERCOUNT) AS JYDFMCGROUPMEMBERCOUNT,

  MAX(CXKH) AS CXKH,

  MAX(JYMC) AS JYMC,

  MAX(JYZJHM) AS JYZJHM , 

  MAX(JYDFZKH) AS JYDFZKH,

  MAX(JYDFMC) AS JYDFMC,

  MAX(JYDFZJHM) AS JYDFZJHM,

  SUM( CASE WHEN JYJE IS NULL THEN 0 ELSE JYJE END ) AS JYZJE ,

  COUNT(1) AS JYZBS ,

  SUM(CASE WHEN (JDBZ ='出' ) THEN JYJE ELSE 0 END) AS CZJE ,

  SUM(CASE WHEN (JDBZ ='出' ) THEN 1 ELSE 0 END) AS CZBS ,

  SUM(CASE WHEN (JDBZ ='进' ) THEN JYJE ELSE 0 END) AS JZJE,

  SUM(CASE WHEN (JDBZ ='进' ) THEN 1 ELSE 0 END) AS JZBS,

  SUM(CASE WHEN (JDBZ ='进' ) THEN JYJE ELSE -JYJE END) AS JCZCE,		

  MIN(JYSJ) AS ZZJYRQ,

  MAX(JYSJ) AS ZWJYRQ,

  MAX(JDBZ) AS JDBZ,

  MAX(JYDFMCGROUP) AS MAXDSGROUPNAME

  FROM 



  (  SELECT *, (CASE WHEN CXKHGROUPNAME IS NULL THEN CXKH ELSE CXKHGROUPNAME END) AS CXKHGROUP,  (CASE WHEN JYDFZKHGROUPNAME IS NULL THEN JYDFZKH ELSE JYDFZKHGROUPNAME END) AS JYDFZKHGROUP,  (CASE WHEN JYZJHMGROUPNAME IS NULL THEN JYZJHM ELSE JYZJHMGROUPNAME END) AS JYZJHMGROUP, (CASE WHEN JYDFZJHMGROUPNAME IS NULL THEN JYDFZJHM ELSE JYDFZJHMGROUPNAME END) AS JYDFZJHMGROUP,  (CASE WHEN JYMCGROUPNAME IS NULL THEN JYMC ELSE JYMCGROUPNAME END) AS JYMCGROUP,  (CASE WHEN JYDFMCGROUPNAME IS NULL THEN JYDFMC ELSE JYDFMCGROUPNAME END) AS JYDFMCGROUP  FROM(  (SELECT * FROM mz_bank_records WHERE AJID = 1447663931 )BANK  LEFT JOIN (SELECT GROUPNAME AS CXKHGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS CXKHGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP1 on BANK.CXKH = GROUP1.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZKHGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFZKHGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP2 on BANK.JYDFZKH = GROUP2.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYZJHMGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYZJHMGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP3 on BANK.JYZJHM = GROUP3.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZJHMGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFZJHMGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP4 on BANK.JYDFZJHM = GROUP4.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYMCGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYMCGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP5 on BANK.JYMC = GROUP5.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFMCGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFMCGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP6 on BANK.JYDFMC = GROUP6.GROUPMEMBER  )ALLBANK)GROUPBANKTABLE



  WHERE  AJID = 1447663931     AND JYMCGROUP IS NOT NULL AND  JYDFMCGROUP IS NOT NULL AND (LENGTH( COALESCE(JYMCGROUP, '0'))>0) AND  (LENGTH( COALESCE(JYDFMCGROUP, '0'))>0) 

  GROUP BY FLAG

)J WHERE JYMCGROUP!=MAXDSGROUPNAME and JYZJE >= 1000000 AND JYZBS >= 10 )  ORDER BY JYZBS DESC 
```



##### 证件号码

```sql
(SELECT * FROM(

  SELECT  

  CASE WHEN JYZJHMGROUP >= JYDFZJHMGROUP then JYZJHMGROUP||JYDFZJHMGROUP else JYDFZJHMGROUP||JYZJHMGROUP end as FLAG,

  MAX(JYZJHMGROUP) AS JYZJHMGROUP,

  MIN(JYDFZJHMGROUP) AS JYDFZJHMGROUP,

  MAX(CASE WHEN JYZJHMGROUP >= JYDFZJHMGROUP then JYZJHMGROUPMEMBERCOUNT else JYDFZJHMGROUPMEMBERCOUNT end) AS JYZJHMGROUPMEMBERCOUNT,

  MAX(CASE WHEN JYZJHMGROUP >= JYDFZJHMGROUP then JYDFZJHMGROUPMEMBERCOUNT else JYZJHMGROUPMEMBERCOUNT end) AS JYDFZJHMGROUPMEMBERCOUNT,

  MAX(CASE WHEN JYZJHMGROUP >= JYDFZJHMGROUP then CXKH else JYDFZKH end) AS CXKH,

  MAX(CASE WHEN JYZJHMGROUP >= JYDFZJHMGROUP then JYMC else JYDFMC end) AS JYMC,

  MAX(CASE WHEN JYZJHMGROUP >= JYDFZJHMGROUP then JYZJHM else JYDFZJHM end) AS JYZJHM,

  MAX(CASE WHEN JYZJHMGROUP >= JYDFZJHMGROUP then JYDFZKH else CXKH end) AS JYDFZKH,

  MAX(CASE WHEN JYZJHMGROUP >= JYDFZJHMGROUP then JYDFMC else JYMC end) AS JYDFMC,

  MAX(CASE WHEN JYZJHMGROUP >= JYDFZJHMGROUP then JYDFZJHM else JYZJHM end) AS JYDFZJHM,

  SUM( CASE WHEN JYJE IS NULL THEN 0 ELSE JYJE END ) AS JYZJE ,

  COUNT(1) AS JYZBS ,

  SUM(CASE WHEN (JDBZ ='出' AND JYZJHMGROUP >= JYDFZJHMGROUP) OR (JDBZ ='进' AND JYZJHMGROUP < JYDFZJHMGROUP) THEN JYJE ELSE 0 END) AS CZJE ,

  SUM(CASE WHEN (JDBZ ='出' AND JYZJHMGROUP >= JYDFZJHMGROUP) OR (JDBZ ='进' AND JYZJHMGROUP < JYDFZJHMGROUP) THEN 1 ELSE 0 END) AS CZBS ,

  SUM(CASE WHEN (JDBZ ='进' AND JYZJHMGROUP >= JYDFZJHMGROUP) OR (JDBZ ='出' AND JYZJHMGROUP < JYDFZJHMGROUP) THEN JYJE ELSE 0 END) AS JZJE,

  SUM(CASE WHEN (JDBZ ='进' AND JYZJHMGROUP >= JYDFZJHMGROUP) OR (JDBZ ='出' AND JYZJHMGROUP < JYDFZJHMGROUP) THEN 1 ELSE 0 END) AS JZBS,

  SUM(CASE WHEN (JDBZ ='进' AND JYZJHMGROUP >= JYDFZJHMGROUP) OR (JDBZ ='出' AND JYZJHMGROUP < JYDFZJHMGROUP) THEN JYJE ELSE -JYJE END) AS JCZCE,

  MIN(JYSJ) AS ZZJYRQ,

  MAX(JYSJ) AS ZWJYRQ,

  MAX(JDBZ) AS JDBZ,

  MAX(JYDFZJHMGROUP) AS MAXDSGROUPNAME

  FROM 



  (  SELECT *, (CASE WHEN CXKHGROUPNAME IS NULL THEN CXKH ELSE CXKHGROUPNAME END) AS CXKHGROUP,  (CASE WHEN JYDFZKHGROUPNAME IS NULL THEN JYDFZKH ELSE JYDFZKHGROUPNAME END) AS JYDFZKHGROUP,  (CASE WHEN JYZJHMGROUPNAME IS NULL THEN JYZJHM ELSE JYZJHMGROUPNAME END) AS JYZJHMGROUP, (CASE WHEN JYDFZJHMGROUPNAME IS NULL THEN JYDFZJHM ELSE JYDFZJHMGROUPNAME END) AS JYDFZJHMGROUP,  (CASE WHEN JYMCGROUPNAME IS NULL THEN JYMC ELSE JYMCGROUPNAME END) AS JYMCGROUP,  (CASE WHEN JYDFMCGROUPNAME IS NULL THEN JYDFMC ELSE JYDFMCGROUPNAME END) AS JYDFMCGROUP  FROM(  (SELECT * FROM mz_bank_records WHERE AJID = 1447663931 )BANK  LEFT JOIN (SELECT GROUPNAME AS CXKHGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS CXKHGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP1 on BANK.CXKH = GROUP1.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZKHGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFZKHGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP2 on BANK.JYDFZKH = GROUP2.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYZJHMGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYZJHMGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP3 on BANK.JYZJHM = GROUP3.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZJHMGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFZJHMGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP4 on BANK.JYDFZJHM = GROUP4.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYMCGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYMCGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP5 on BANK.JYMC = GROUP5.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFMCGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFMCGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP6 on BANK.JYDFMC = GROUP6.GROUPMEMBER  )ALLBANK)GROUPBANKTABLE



  WHERE  AJID = 1447663931     AND JYZJHMGROUP IS NOT NULL AND  JYDFZJHMGROUP IS NOT NULL AND (LENGTH( COALESCE(JYZJHMGROUP, '0'))>0) AND  (LENGTH( COALESCE(JYDFZJHMGROUP, '0'))>0) 

  GROUP BY FLAG

)J WHERE JYZJHMGROUP=MAXDSGROUPNAME and JYZJE >= 1000000 AND JYZBS >= 10  )



UNION ALL



(SELECT * FROM(

  SELECT  

  CASE WHEN JYZJHMGROUP >= JYDFZJHMGROUP then JYZJHMGROUP||JYDFZJHMGROUP else JYDFZJHMGROUP||JYZJHMGROUP end as FLAG,

  MAX(JYZJHMGROUP) AS JYZJHMGROUP,

  MAX(JYDFZJHMGROUP) AS JYDFZJHMGROUP,

  MAX(JYZJHMGROUPMEMBERCOUNT) AS JYZJHMGROUPMEMBERCOUNT,

  MAX(JYDFZJHMGROUPMEMBERCOUNT) AS JYDFZJHMGROUPMEMBERCOUNT,

  MAX(CXKH) AS CXKH,

  MAX(JYMC) AS JYMC,

  MAX(JYZJHM) AS JYZJHM , 

  MAX(JYDFZKH) AS JYDFZKH,

  MAX(JYDFMC) AS JYDFMC,

  MAX(JYDFZJHM) AS JYDFZJHM,

  SUM( CASE WHEN JYJE IS NULL THEN 0 ELSE JYJE END ) AS JYZJE ,

  COUNT(1) AS JYZBS ,

  SUM(CASE WHEN (JDBZ ='出' ) THEN JYJE ELSE 0 END) AS CZJE ,

  SUM(CASE WHEN (JDBZ ='出' ) THEN 1 ELSE 0 END) AS CZBS ,

  SUM(CASE WHEN (JDBZ ='进' ) THEN JYJE ELSE 0 END) AS JZJE,

  SUM(CASE WHEN (JDBZ ='进' ) THEN 1 ELSE 0 END) AS JZBS,

  SUM(CASE WHEN (JDBZ ='进' ) THEN JYJE ELSE -JYJE END) AS JCZCE,		

  MIN(JYSJ) AS ZZJYRQ,

  MAX(JYSJ) AS ZWJYRQ,

  MAX(JDBZ) AS JDBZ,

  MAX(JYDFZJHMGROUP) AS MAXDSGROUPNAME

  FROM 



  (  SELECT *, (CASE WHEN CXKHGROUPNAME IS NULL THEN CXKH ELSE CXKHGROUPNAME END) AS CXKHGROUP,  (CASE WHEN JYDFZKHGROUPNAME IS NULL THEN JYDFZKH ELSE JYDFZKHGROUPNAME END) AS JYDFZKHGROUP,  (CASE WHEN JYZJHMGROUPNAME IS NULL THEN JYZJHM ELSE JYZJHMGROUPNAME END) AS JYZJHMGROUP, (CASE WHEN JYDFZJHMGROUPNAME IS NULL THEN JYDFZJHM ELSE JYDFZJHMGROUPNAME END) AS JYDFZJHMGROUP,  (CASE WHEN JYMCGROUPNAME IS NULL THEN JYMC ELSE JYMCGROUPNAME END) AS JYMCGROUP,  (CASE WHEN JYDFMCGROUPNAME IS NULL THEN JYDFMC ELSE JYDFMCGROUPNAME END) AS JYDFMCGROUP  FROM(  (SELECT * FROM mz_bank_records WHERE AJID = 1447663931 )BANK  LEFT JOIN (SELECT GROUPNAME AS CXKHGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS CXKHGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP1 on BANK.CXKH = GROUP1.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZKHGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFZKHGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP2 on BANK.JYDFZKH = GROUP2.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYZJHMGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYZJHMGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP3 on BANK.JYZJHM = GROUP3.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZJHMGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFZJHMGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP4 on BANK.JYDFZJHM = GROUP4.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYMCGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYMCGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP5 on BANK.JYMC = GROUP5.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFMCGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFMCGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP6 on BANK.JYDFMC = GROUP6.GROUPMEMBER  )ALLBANK)GROUPBANKTABLE



  WHERE  AJID = 1447663931     AND JYZJHMGROUP IS NOT NULL AND  JYDFZJHMGROUP IS NOT NULL AND (LENGTH( COALESCE(JYZJHMGROUP, '0'))>0) AND  (LENGTH( COALESCE(JYDFZJHMGROUP, '0'))>0) 

  GROUP BY FLAG

)J WHERE JYZJHMGROUP!=MAXDSGROUPNAME and JYZJE >= 1000000 AND JYZBS >= 10 )  ORDER BY JYZBS DESC
```



##### 账号、卡号

```sql
(SELECT * FROM(

  SELECT  

  CASE WHEN CXKHGROUP >= JYDFZKHGROUP then CXKHGROUP||JYDFZKHGROUP else JYDFZKHGROUP||CXKHGROUP end as FLAG,

  MAX(CXKHGROUP) AS CXKHGROUP,

  MIN(JYDFZKHGROUP) AS JYDFZKHGROUP,

  MAX(CASE WHEN CXKHGROUP >= JYDFZKHGROUP then CXKHGROUPMEMBERCOUNT else JYDFZKHGROUPMEMBERCOUNT end) AS CXKHGROUPMEMBERCOUNT,

  MAX(CASE WHEN CXKHGROUP >= JYDFZKHGROUP then JYDFZKHGROUPMEMBERCOUNT else CXKHGROUPMEMBERCOUNT end) AS JYDFZKHGROUPMEMBERCOUNT,

  MAX(CASE WHEN CXKHGROUP >= JYDFZKHGROUP then CXKH else JYDFZKH end) AS CXKH,

  MAX(CASE WHEN CXKHGROUP >= JYDFZKHGROUP then JYMC else JYDFMC end) AS JYMC,

  MAX(CASE WHEN CXKHGROUP >= JYDFZKHGROUP then JYZJHM else JYDFZJHM end) AS JYZJHM,

  MAX(CASE WHEN CXKHGROUP >= JYDFZKHGROUP then JYDFZKH else CXKH end) AS JYDFZKH,

  MAX(CASE WHEN CXKHGROUP >= JYDFZKHGROUP then JYDFMC else JYMC end) AS JYDFMC,

  MAX(CASE WHEN CXKHGROUP >= JYDFZKHGROUP then JYDFZJHM else JYZJHM end) AS JYDFZJHM,

  SUM( CASE WHEN JYJE IS NULL THEN 0 ELSE JYJE END ) AS JYZJE ,

  COUNT(1) AS JYZBS ,

  SUM(CASE WHEN (JDBZ ='出' AND CXKHGROUP >= JYDFZKHGROUP) OR (JDBZ ='进' AND CXKHGROUP < JYDFZKHGROUP) THEN JYJE ELSE 0 END) AS CZJE ,

  SUM(CASE WHEN (JDBZ ='出' AND CXKHGROUP >= JYDFZKHGROUP) OR (JDBZ ='进' AND CXKHGROUP < JYDFZKHGROUP) THEN 1 ELSE 0 END) AS CZBS ,

  SUM(CASE WHEN (JDBZ ='进' AND CXKHGROUP >= JYDFZKHGROUP) OR (JDBZ ='出' AND CXKHGROUP < JYDFZKHGROUP) THEN JYJE ELSE 0 END) AS JZJE,

  SUM(CASE WHEN (JDBZ ='进' AND CXKHGROUP >= JYDFZKHGROUP) OR (JDBZ ='出' AND CXKHGROUP < JYDFZKHGROUP) THEN 1 ELSE 0 END) AS JZBS,

  SUM(CASE WHEN (JDBZ ='进' AND CXKHGROUP >= JYDFZKHGROUP) OR (JDBZ ='出' AND CXKHGROUP < JYDFZKHGROUP) THEN JYJE ELSE -JYJE END) AS JCZCE,

  MIN(JYSJ) AS ZZJYRQ,

  MAX(JYSJ) AS ZWJYRQ,

  MAX(JDBZ) AS JDBZ,

  MAX(JYDFZKHGROUP) AS MAXDSGROUPNAME

  FROM 



  (  SELECT *, (CASE WHEN CXKHGROUPNAME IS NULL THEN CXKH ELSE CXKHGROUPNAME END) AS CXKHGROUP,  (CASE WHEN JYDFZKHGROUPNAME IS NULL THEN JYDFZKH ELSE JYDFZKHGROUPNAME END) AS JYDFZKHGROUP,  (CASE WHEN JYZJHMGROUPNAME IS NULL THEN JYZJHM ELSE JYZJHMGROUPNAME END) AS JYZJHMGROUP, (CASE WHEN JYDFZJHMGROUPNAME IS NULL THEN JYDFZJHM ELSE JYDFZJHMGROUPNAME END) AS JYDFZJHMGROUP,  (CASE WHEN JYMCGROUPNAME IS NULL THEN JYMC ELSE JYMCGROUPNAME END) AS JYMCGROUP,  (CASE WHEN JYDFMCGROUPNAME IS NULL THEN JYDFMC ELSE JYDFMCGROUPNAME END) AS JYDFMCGROUP  FROM(  (SELECT * FROM mz_bank_records WHERE AJID = 1447663931 )BANK  LEFT JOIN (SELECT GROUPNAME AS CXKHGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS CXKHGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP1 on BANK.CXKH = GROUP1.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZKHGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFZKHGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP2 on BANK.JYDFZKH = GROUP2.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYZJHMGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYZJHMGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP3 on BANK.JYZJHM = GROUP3.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZJHMGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFZJHMGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP4 on BANK.JYDFZJHM = GROUP4.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYMCGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYMCGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP5 on BANK.JYMC = GROUP5.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFMCGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFMCGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP6 on BANK.JYDFMC = GROUP6.GROUPMEMBER  )ALLBANK)GROUPBANKTABLE



  WHERE  AJID = 1447663931     AND CXKHGROUP IS NOT NULL AND  JYDFZKHGROUP IS NOT NULL AND (LENGTH( COALESCE(CXKHGROUP, '0'))>0) AND  (LENGTH( COALESCE(JYDFZKHGROUP, '0'))>0) 

  GROUP BY FLAG

)J WHERE CXKHGROUP=MAXDSGROUPNAME and JYZJE >= 1000000 AND JYZBS >= 10  )



UNION ALL



(SELECT * FROM(

  SELECT  

  CASE WHEN CXKHGROUP >= JYDFZKHGROUP then CXKHGROUP||JYDFZKHGROUP else JYDFZKHGROUP||CXKHGROUP end as FLAG,

  MAX(CXKHGROUP) AS CXKHGROUP,

  MAX(JYDFZKHGROUP) AS JYDFZKHGROUP,

  MAX(CXKHGROUPMEMBERCOUNT) AS CXKHGROUPMEMBERCOUNT,

  MAX(JYDFZKHGROUPMEMBERCOUNT) AS JYDFZKHGROUPMEMBERCOUNT,

  MAX(CXKH) AS CXKH,

  MAX(JYMC) AS JYMC,

  MAX(JYZJHM) AS JYZJHM , 

  MAX(JYDFZKH) AS JYDFZKH,

  MAX(JYDFMC) AS JYDFMC,

  MAX(JYDFZJHM) AS JYDFZJHM,

  SUM( CASE WHEN JYJE IS NULL THEN 0 ELSE JYJE END ) AS JYZJE ,

  COUNT(1) AS JYZBS ,

  SUM(CASE WHEN (JDBZ ='出' ) THEN JYJE ELSE 0 END) AS CZJE ,

  SUM(CASE WHEN (JDBZ ='出' ) THEN 1 ELSE 0 END) AS CZBS ,

  SUM(CASE WHEN (JDBZ ='进' ) THEN JYJE ELSE 0 END) AS JZJE,

  SUM(CASE WHEN (JDBZ ='进' ) THEN 1 ELSE 0 END) AS JZBS,

  SUM(CASE WHEN (JDBZ ='进' ) THEN JYJE ELSE -JYJE END) AS JCZCE,		

  MIN(JYSJ) AS ZZJYRQ,

  MAX(JYSJ) AS ZWJYRQ,

  MAX(JDBZ) AS JDBZ,

  MAX(JYDFZKHGROUP) AS MAXDSGROUPNAME

  FROM 



  (  SELECT *, (CASE WHEN CXKHGROUPNAME IS NULL THEN CXKH ELSE CXKHGROUPNAME END) AS CXKHGROUP,  (CASE WHEN JYDFZKHGROUPNAME IS NULL THEN JYDFZKH ELSE JYDFZKHGROUPNAME END) AS JYDFZKHGROUP,  (CASE WHEN JYZJHMGROUPNAME IS NULL THEN JYZJHM ELSE JYZJHMGROUPNAME END) AS JYZJHMGROUP, (CASE WHEN JYDFZJHMGROUPNAME IS NULL THEN JYDFZJHM ELSE JYDFZJHMGROUPNAME END) AS JYDFZJHMGROUP,  (CASE WHEN JYMCGROUPNAME IS NULL THEN JYMC ELSE JYMCGROUPNAME END) AS JYMCGROUP,  (CASE WHEN JYDFMCGROUPNAME IS NULL THEN JYDFMC ELSE JYDFMCGROUPNAME END) AS JYDFMCGROUP  FROM(  (SELECT * FROM mz_bank_records WHERE AJID = 1447663931 )BANK  LEFT JOIN (SELECT GROUPNAME AS CXKHGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS CXKHGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP1 on BANK.CXKH = GROUP1.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZKHGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFZKHGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'CXKH&JYDFZKH' AND TABLENAME = 'mz_bank_records')GROUP2 on BANK.JYDFZKH = GROUP2.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYZJHMGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYZJHMGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP3 on BANK.JYZJHM = GROUP3.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFZJHMGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFZJHMGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYZJHM&JYDFZJHM' AND TABLENAME = 'mz_bank_records')GROUP4 on BANK.JYDFZJHM = GROUP4.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYMCGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYMCGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP5 on BANK.JYMC = GROUP5.GROUPMEMBER  LEFT JOIN (SELECT GROUPNAME AS JYDFMCGROUPNAME, GROUPMEMBER, GROUPMEMBERCOUNT AS JYDFMCGROUPMEMBERCOUNT FROM mark_group_detail WHERE AJID = 1447663931 AND TABLECOLUMN = 'JYMC&JYDFMC' AND TABLENAME = 'mz_bank_records')GROUP6 on BANK.JYDFMC = GROUP6.GROUPMEMBER  )ALLBANK)GROUPBANKTABLE



  WHERE  AJID = 1447663931     AND CXKHGROUP IS NOT NULL AND  JYDFZKHGROUP IS NOT NULL AND (LENGTH( COALESCE(CXKHGROUP, '0'))>0) AND  (LENGTH( COALESCE(JYDFZKHGROUP, '0'))>0) 

  GROUP BY FLAG

)J WHERE CXKHGROUP!=MAXDSGROUPNAME and JYZJE >= 1000000 AND JYZBS >= 10 )  ORDER BY JYZBS DESC 
```

##### 输出字段：

序号（++），交易方户名（组）/交易方证件号（组）/交易卡号（组）（查询结果第二列），对手户名（组）/对手证件号（组）/对手卡号（组）（查询结果第三列），交易总金额（jyzje），交易总笔数(jyzbs)，出账金额(czje)，出账笔数(czbs)，进账金额(jzje)，进账笔数(jzbs)，进出帐差额(jczce)，最早交易日期(zzjyrq)，最晚交易日期(zwjyrq)



### 三、待调单账户分析模型

#### 1.主要人员未调单对手账户

> 未调单的账户是指仅仅存在于对手账户中而不存在于交易账户中。

```sql
select
		MAX(JYMC) as JYMC,
		JYDFZKH as ZH,
		JYDFMC as MC,
		JYDFZJHM as ZJHM ,
		JYDFZHKHH as KHH,
		'添加到待调单' as DDYY
	from
		mz_bank_records
	where
		AJID = 1447663931
		and JYDFZKH is not null
		and (LENGTH( coalesce(JYDFZKH , '0'))>0)
		and JYDFZKH not in (
		select
			distinct CXKH
		from
			mz_bank_records
		where
			AJID = 1447663931
			and CXKH is not null
			and (LENGTH( coalesce(CXKH, '0'))>0))
	group by
		JYDFZKH,
		JYDFMC,
		JYDFZJHM,
		JYDFZHKHH
	order by
		JYMC desc
```

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cnq1sieuj31pu0c6444.jpg)

#### 2.大额交易对手未调单账户

> 统计交易记录中交易金额超过某阈值的未调单的账户。

```sql
select
		MAX(JYMC) as JYMC,
		JYDFZKH as ZH,
		JYDFMC as MC,
		JYDFZJHM as ZJHM ,
		JYDFZHKHH as KHH,
		'添加到待调单' as DDYY
	from
		mz_bank_records
	where
		AJID = 1447663931
		and JYJE >= 1000000
		and JYDFZKH is not null
		and (LENGTH( coalesce(JYDFZKH , '0'))>0)
		and JYDFZKH not in (
		select
			distinct CXKH
		from
			mz_bank_records
		where
			AJID = 1447663931
			and CXKH is not null
			and (LENGTH( coalesce(CXKH , '0'))>0))
	group by
		JYDFZKH,
		JYDFMC,
		JYDFZJHM,
		JYDFZHKHH
	order by
		JYMC desc
```

![image-20220518165434338](/Users/baiyang/Library/Application Support/typora-user-images/image-20220518165434338.png)

#### 3.大额获利对手未调单账户

> 统计交易记录中获利金额【进账 - 出账】大于某阈值的未调单账户。

```sql
	select
		JYDFZKH as ZH,
		JYDFMC as MC,
		JYDFZJHM as ZJHM,
		JYDFZHKHH as KHH,
		'添加到待调单' as DDYY
	from
		(
		select
			JYDFZKH,
			JYDFMC,
			JYDFZJHM,
			JYDFZHKHH,
      /*计算出进出总差额*/
			SUM(case when JDBZ = '出' then JYJE else 0 end) - SUM(case when JDBZ = '进' then JYJE else 0 end) JCZCE
		from
			mz_bank_records
		where
			AJID = 1447663931
		group by
			JYDFZKH,
			JYDFMC,
			JYDFZJHM,
			JYDFZHKHH) T
	where
		JCZCE >= '20000'
		and JYDFZKH is not null
		and (LENGTH( coalesce(JYDFZKH , '0'))>0)
		/*排除掉对方账号*/
		and JYDFZKH not in (
		select
			distinct CXKH
		from
			mz_bank_records
		where
			AJID = 1447663931
			and CXKH is not null
			and (LENGTH( coalesce(CXKH , '0'))>0))
	order by
		JYDFZKH desc 
```

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cntkhogvj323i0nsnbq.jpg)

#### 4.主要关联对手未调单账户

> 查找未调单的用户中关联的交易用户大于某阈值的对手账户，阈值参数可设置

```sql
	select
		JYDFZKH as ZH,
		JYDFMC as MC,
		JYDFZJHM as ZJHM,
		JYDFZHKHH as KHH,
		'添加到待调单' as DDYY
	from
		(
		select
			JYDFZKH,
			JYDFMC,
			JYDFZJHM,
			JYDFZHKHH,
			COUNT(distinct CXKH) GLDDZHS
		from
			mz_bank_records
		where
			AJID = 1447663931
		group by
			JYDFZKH,
			JYDFMC,
			JYDFZJHM,
			JYDFZHKHH) T
	where
		GLDDZHS > '1'
		and JYDFZKH is not null
		and (LENGTH( coalesce(JYDFZKH , '0'))>0)
		and JYDFZKH not in (
		select
			distinct CXKH
		from
			mz_bank_records
		where
			AJID = 1447663931
			and CXKH is not null
			and (LENGTH( coalesce(CXKH , '0'))>0))
	order by
		JYDFZKH desc 
```

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cnvy9ur5j322c0cetgl.jpg)

#### 5.即进即出对手未调单账户

> 统计交易记录中在某一个时间范围内发生了进账金额接近出账金额的未调单账户。

```sql
select
	ZH,
	MC,
	ZJHM,
	KHH,
	DDYY
from
	(
	select
		T1.CXKH as ZH,
		T1.JYMC as MC ,
		T1.JYZJHM as ZJHM,
		T1.JYKHH as KHH,
		'添加到待调单' as DDYY
	from
		(
		select
			case
				JDBZ when '出' then CXKH
				else JYDFZKH
			end as CXKH,
			case
				JDBZ when '出' then JYMC
				else JYDFMC
			end as JYMC,
			case
				JDBZ when '出' then JYZJHM
				else JYDFZJHM
			end as JYZJHM,
			case
				JDBZ when '出' then JYKHH
				else JYDFZHKHH
			end as JYKHH,
			JYSJ,
			'出' as JDBZ,
			JYJE,
			case
				JDBZ when '出' then JYDFZKH
				else CXKH
			end as JYDFZKH,
			case
				JDBZ when '出' then JYDFMC
				else JYMC
			end as JYDFMC,
			case
				JDBZ when '出' then JYDFZJHM
				else JYZJHM
			end as JYDFZJHM,
			case
				JDBZ when '出' then JYDFZHKHH
				else JYKHH
			end as JYDFZHKHH
		from
			mz_bank_records
		where
			AJID = 1447663931
			and (LENGTH( coalesce(JYSJ, '0'))>0)

  ) T1,
		(
		select
			case
				JDBZ when '出' then CXKH
				else JYDFZKH
			end as CXKH,
			case
				JDBZ when '出' then JYMC
				else JYDFMC
			end as JYMC,
			case
				JDBZ when '出' then JYZJHM
				else JYDFZJHM
			end as JYZJHM,
			case
				JDBZ when '出' then JYKHH
				else JYDFZHKHH
			end as JYKHH,
			JYSJ,
			'出' as JDBZ,
			JYJE,
			case
				JDBZ when '出' then JYDFZKH
				else CXKH
			end as JYDFZKH,
			case
				JDBZ when '出' then JYDFMC
				else JYMC
			end as JYDFMC,
			case
				JDBZ when '出' then JYDFZJHM
				else JYZJHM
			end as JYDFZJHM,
			case
				JDBZ when '出' then JYDFZHKHH
				else JYKHH
			end as JYDFZHKHH
		from
			mz_bank_records
		where
			AJID = 1447663931
			and (LENGTH( coalesce(JYSJ, '0'))>0)

  ) T2
	where
		T1.JYDFZKH is not null
		and T1.JYDFZKH = T2.CXKH
		and T2.JYSJ::TIMESTAMP between T1.JYSJ::TIMESTAMP and T1.JYSJ::TIMESTAMP + interval '24 HOUR'
		and T2.JYJE between T1.JYJE * 0.9 and T1.JYJE * 1.1
		and T1.JYJE>1000000
union
	select
		T2.JYDFZKH as ZH,
		T2.JYDFMC as MC ,
		T2.JYDFZJHM as ZJHM,
		T2.JYDFZHKHH as KHH,
		'添加到待调单' as DDYY
	from
		(
		select
			case
				JDBZ when '出' then CXKH
				else JYDFZKH
			end as CXKH,
			case
				JDBZ when '出' then JYMC
				else JYDFMC
			end as JYMC,
			case
				JDBZ when '出' then JYZJHM
				else JYDFZJHM
			end as JYZJHM,
			case
				JDBZ when '出' then JYKHH
				else JYDFZHKHH
			end as JYKHH,
			JYSJ,
			'出' as JDBZ,
			JYJE,
			case
				JDBZ when '出' then JYDFZKH
				else CXKH
			end as JYDFZKH,
			case
				JDBZ when '出' then JYDFMC
				else JYMC
			end as JYDFMC,
			case
				JDBZ when '出' then JYDFZJHM
				else JYZJHM
			end as JYDFZJHM,
			case
				JDBZ when '出' then JYDFZHKHH
				else JYKHH
			end as JYDFZHKHH
		from
			mz_bank_records
		where
			AJID = 1447663931
			and (LENGTH( coalesce(JYSJ, '0'))>0)

  ) T1,
		(
		select
			case
				JDBZ when '出' then CXKH
				else JYDFZKH
			end as CXKH,
			case
				JDBZ when '出' then JYMC
				else JYDFMC
			end as JYMC,
			case
				JDBZ when '出' then JYZJHM
				else JYDFZJHM
			end as JYZJHM,
			case
				JDBZ when '出' then JYKHH
				else JYDFZHKHH
			end as JYKHH,
			JYSJ,
			'出' as JDBZ,
			JYJE,
			case
				JDBZ when '出' then JYDFZKH
				else CXKH
			end as JYDFZKH,
			case
				JDBZ when '出' then JYDFMC
				else JYMC
			end as JYDFMC,
			case
				JDBZ when '出' then JYDFZJHM
				else JYZJHM
			end as JYDFZJHM,
			case
				JDBZ when '出' then JYDFZHKHH
				else JYKHH
			end as JYDFZHKHH
		from
			mz_bank_records
		where
			AJID = 1447663931
			and (LENGTH( coalesce(JYSJ, '0'))>0)

  ) T2
	where
		T1.JYDFZKH is not null
		and (LENGTH( coalesce(T1.JYDFZKH, '0'))>0)
		and T1.JYDFZKH = T2.CXKH
		and T2.JYSJ::TIMESTAMP between T1.JYSJ::TIMESTAMP and T1.JYSJ::TIMESTAMP + interval '24 HOUR'
		and T2.JYJE between T1.JYJE * 0.9 and T1.JYJE * 1.1
		and T1.JYJE>1000000

 ) T3
where
	ZH not in (
	select
		distinct CXKH
	from
		mz_bank_records
	where
		AJID = 1447663931
		and CXKH is not null
		and (LENGTH( coalesce(CXKH, '0'))>0))
order by
	ZH desc
```

![image-20220518170033750](/Users/baiyang/Library/Application Support/typora-user-images/image-20220518170033750.png)

### 四、关联交易分析模型

#### 1. 交易账户关联对手账户(人)数

> 根据交易记录统计出交易账户关联的对手人数，关联对手账号数，关联出账对手人数，关联出账对手账号数，关联进账对手人数，关联进账对手账号数，进账笔数，进账金额，出账笔数，出账金额，进出总差额

```sql
    SELECT
    CXKH,
    MAX ( JYMC ) JYMC,
    MAX ( JYZJHM ) JYZJHM,
    COUNT ( DISTINCT JYDFMC ) GLDSRS,
    COUNT ( DISTINCT JYDFZKH ) AS GLDSZHS,
    COUNT ( DISTINCT ( CASE JDBZ WHEN '出' THEN JYDFMC END ) ) AS CGLDSRS,
    COUNT ( DISTINCT ( CASE JDBZ WHEN '出' THEN JYDFZKH END ) ) AS CGLDSZHS,
    COUNT ( DISTINCT ( CASE JDBZ WHEN '进' THEN JYDFMC END ) ) AS JGLDSRS,
    COUNT ( DISTINCT ( CASE JDBZ WHEN '进' THEN JYDFZKH END ) ) AS JGLDSZHS,
    SUM ( CASE JDBZ WHEN '出' THEN JYJE ELSE 0 END ) AS CZJE,
    SUM ( CASE JDBZ WHEN '出' THEN 1 ELSE 0 END ) AS CZBS,
    SUM ( CASE JDBZ WHEN '进' THEN JYJE ELSE 0 END ) AS JZJE,
    SUM ( CASE JDBZ WHEN '进' THEN 1 ELSE 0 END ) AS JZBS,
    SUM ( CASE JDBZ WHEN '进' THEN JYJE ELSE - JYJE END ) AS JCZCE 
    FROM
    mz_bank_records
    WHERE
    AJID = 1447663931  
    AND CXKH IS NOT NULL 
    GROUP BY
    CXKH ORDER BY GLDSRS DESC 
```

##### 输出字段：

序号（++），交易卡号（cxkh），交易名称（jymc），交易证件号码(jyzjhm)，关联对手人数(gldsrs)，关联对手账号数(gldszhs)，关联出账对手人数(cgldsrs)，关联出账对手账号数(cgldszhs)，关联进账对手人数(jgldsrs)，关联进账对手账号数(jgldszhs)，进账笔数(jzbs)，进账金额(jzje)，出账笔数(czbs)，出账金额(czje)，进出总差额(jczce)

#### 2. 交易户名关联对手账户(人)数

> 根据交易记录统计出交易户名关联的对手人数，关联对手账号数，关联出账对手人数，关联出账对手账号数，关联进账对手人数，关联进账对手账号数，进账笔数，进账金额，出账笔数，出账金额，进出总差额

```sql
SELECT
	* 
FROM
	(
    SELECT
    JYMC,
    MAX ( JYZJHM ) JYZJHM,
    COUNT ( DISTINCT JYDFMC ) GLDSRS,
    COUNT ( DISTINCT JYDFZKH ) AS GLDSZHS,
    COUNT ( DISTINCT ( CASE JDBZ WHEN '出' THEN JYDFMC END ) ) AS CGLDSRS,
    COUNT ( DISTINCT ( CASE JDBZ WHEN '出' THEN JYDFZKH END ) ) AS CGLDSZHS,
    COUNT ( DISTINCT ( CASE JDBZ WHEN '进' THEN JYDFMC END ) ) AS JGLDSRS,
    COUNT ( DISTINCT ( CASE JDBZ WHEN '进' THEN JYDFZKH END ) ) AS JGLDSZHS,
    SUM ( CASE JDBZ WHEN '出' THEN JYJE ELSE 0 END ) AS CZJE,
    SUM ( CASE JDBZ WHEN '出' THEN 1 ELSE 0 END ) AS CZBS,
    SUM ( CASE JDBZ WHEN '进' THEN JYJE ELSE 0 END ) AS JZJE,
    SUM ( CASE JDBZ WHEN '进' THEN 1 ELSE 0 END ) AS JZBS,
    SUM ( CASE JDBZ WHEN '进' THEN JYJE ELSE - JYJE END ) AS JCZCE 
    FROM
    mz_bank_records
    WHERE
    AJID = 1447663931  
    AND JYMC IS NOT NULL 
    AND LENGTH ( COALESCE ( JYMC, '0' ) ) > 0 
    GROUP BY
    JYMC ORDER BY GLDSRS DESC 
  ) A 
WHERE
	1 = 1 
```

##### 输出字段：

序号（++），交易名称（jymc），交易证件号码（jyzjhm），关联对手人数(gldsrs)，关联对手帐号数(gldszhs)，关联出账对手人数(cgldsrs)，关联出账对手账号数(cgldszhs)，关联进账对手人数(jgldsrs)，关联进账对手账号数(jgldszhs)，进账笔数(jzbs)，进账金额(jzje)，出账笔数(czbs)，出账金额(czje)，进出总差额(jczce)

#### 3. 对手账户关联交易账户(人)数

> 根据交易记录统计出对手账户关联的调单人数，关联调单账号数，关联出账调单人数，关联出账调单账号数，关联进账调单人数，关联进账调单账号数，进账笔数，进账金额，出账笔数，出账金额，进出总差额

```sql
SELECT
    JYDFZKH,
    MAX ( JYDFMC ) JYDFMC,
    MAX ( JYDFZJHM ) JYDFZJHM,
    COUNT ( DISTINCT JYMC ) GLDDRS,
    COUNT ( DISTINCT CXKH ) GLDDZHS,
    COUNT ( DISTINCT ( CASE JDBZ WHEN '出' THEN JYMC END ) ) AS CGLDDRS,
    COUNT ( DISTINCT ( CASE JDBZ WHEN '出' THEN CXKH END ) ) AS CGLDDZHS,
    COUNT ( DISTINCT ( CASE JDBZ WHEN '进' THEN JYMC END ) ) AS JGLDDRS,
    COUNT ( DISTINCT ( CASE JDBZ WHEN '进' THEN CXKH END ) ) AS JGLDDZHS,
    SUM ( CASE JDBZ WHEN '出' THEN JYJE ELSE 0 END ) AS CZJE,
    SUM ( CASE JDBZ WHEN '出' THEN 1 ELSE 0 END ) AS CZBS,
    SUM ( CASE JDBZ WHEN '进' THEN JYJE ELSE 0 END ) AS JZJE,
    SUM ( CASE JDBZ WHEN '进' THEN 1 ELSE 0 END ) AS JZBS,
    SUM ( CASE JDBZ WHEN '进' THEN JYJE ELSE - JYJE END ) AS JCZCE 
    FROM
		mz_bank_records
    WHERE
    AJID = 1447663931  
    AND JYDFZKH IS NOT NULL 
    AND LENGTH ( COALESCE ( JYDFZKH, '0' ) ) > 0 
    GROUP BY
    JYDFZKH ORDER BY GLDDZHS DESC 
```

##### 输出字段：

序号（++），对方账号（jydfzkh），对手户名(jydfmc)，对手身份证号(jydfzjhm)，关联调单人数(glddrs)，关联调单账号数(glddzhs)，关联出账调单人数(cglddrs)，关联出账调单账号数(cglddzhs)，关联进账调单人数(jglddrs)，关联进账调单账号数(jglddzhs)，进账笔数(jzbs)，进账金额(jzje)，出账笔数(czbs)，出账金额(czje)，进出总差额(jczce)

#### 4. 对手户名关联交易账户(人)数 

>  根据交易记录统计出对手户名关联的调单人数，关联调单账号数，关联出账调单人数，关联出账调单账号数，关联进账调单人数，关联进账调单账号数，进账笔数，进账金额，出账笔数，出账金额，进出总差额

```sql
SELECT
	* 
FROM
	(
    SELECT
    JYDFMC,
    MAX ( JYDFZJHM ) JYDFZJHM,
    COUNT ( DISTINCT JYMC ) GLDDRS,
    COUNT ( DISTINCT CXKH ) AS GLDDZHS,
    COUNT ( DISTINCT ( CASE JDBZ WHEN '出' THEN JYMC END ) ) AS CGLDDRS,
    COUNT ( DISTINCT ( CASE JDBZ WHEN '出' THEN CXKH END ) ) AS CGLDDZHS,
    COUNT ( DISTINCT ( CASE JDBZ WHEN '进' THEN JYMC END ) ) AS JGLDDRS,
    COUNT ( DISTINCT ( CASE JDBZ WHEN '进' THEN CXKH END ) ) AS JGLDDZHS,
    SUM ( CASE JDBZ WHEN '出' THEN JYJE ELSE 0 END ) AS CZJE,
    SUM ( CASE JDBZ WHEN '出' THEN 1 ELSE 0 END ) AS CZBS,
    SUM ( CASE JDBZ WHEN '进' THEN JYJE ELSE 0 END ) AS JZJE,
    SUM ( CASE JDBZ WHEN '进' THEN 1 ELSE 0 END ) AS JZBS,
    SUM ( CASE JDBZ WHEN '进' THEN JYJE ELSE - JYJE END ) AS JCZCE 
    FROM
    mz_bank_records
    WHERE
    AJID = 1447663931  
    AND JYDFMC IS NOT NULL 
    AND LENGTH ( COALESCE ( JYDFMC, '0' ) ) > 0 
    GROUP BY
    JYDFMC ORDER BY GLDDZHS DESC 
  ) A 
WHERE
	1 = 1 
```

##### 输出字段：

序号(++)，对手户名(jydfmc)，对手身份证号(jydfzjhm)，关联调单人数(glddrs)，关联调单账号数(glddzhs)，关联出账调单人数(cglddrs)，关联出账调单账号数(cglddzhs)，关联进账调单人数(jglddrs)，关联进账调单账号数(jglddzhs)，进账笔数(jzbs)，进账金额(jzje)，出账笔数(czbs)，出账金额(czje)，进出总差额(jczce)

### 五、交易特征分析模型

#### 1. 交易地区分布

> 资金分析系统根据IP地址对用户的地理区域进行补全后
>
> 然后统计交易的地区分布情况。

```sql
SELECT * FROM(

  SELECT  ( CASE WHEN LENGTH ( ipgj ) > 1 THEN ipgj ELSE '' END ) GJMC,
  COUNT(1) ALLCOUNT,
  SUM(CASE JDBZ WHEN '进' THEN 1 ELSE 0 END) INCOUNT,
  SUM(CASE JDBZ WHEN '进' THEN JYJE ELSE 0 END) JZJE ,
  SUM(CASE JDBZ WHEN '出' THEN 1 ELSE 0 END) OUTCOUNT, 
  SUM(CASE JDBZ WHEN '出' THEN JYJE ELSE 0 END) CZJE 
  FROM 
  mz_bank_records
  WHERE AJID=1447663931 
  GROUP BY  GJMC ORDER BY ALLCOUNT DESC)A WHERE 1=1 
```

##### 输出字段：

序号（++），省份名称（sfmc），交易总比数(allcount)，进账笔数(incount)，进账金额(jzje)，出账笔数(outcount)，出账金额(czje)

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cmmedv9ej30zo07stfs.jpg)

#### 2. 交易金额特征

> 根据交易的金额进行分组统计

```sql
SELECT * FROM(
  SELECT JYJE,COUNT(1) ALLCOUNT,
  SUM(CASE JDBZ WHEN '进' THEN 1 ELSE 0 END) INCOUNT,
  SUM(CASE JDBZ WHEN '进' THEN JYJE ELSE 0 END) INJE ,
  SUM(CASE JDBZ WHEN '出' THEN 1 ELSE 0 END) OUTCOUNT, 
  SUM(CASE JDBZ WHEN '出' THEN JYJE ELSE 0 END) OUTJE 
  FROM   
  mz_bank_records
  WHERE AJID=1447663931  And JYJE is not null and  JYJE > 0 
  GROUP BY JYJE ORDER BY ALLCOUNT DESC  )A WHERE 1=1 

```

##### 输出字段：

序号（++），交易金额（jyje)，交易总比数(allcount)，进账笔数(incount)，进账金额(inje)，出账笔数(outcount)，出账金额(outje)

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cmlloxnwj31we0k8gtb.jpg)

#### 3. 交易金额区间规律

> 根据系统预设的金额区间，将交易金额进行分组统计

```sql
SELECT * FROM
(
  SELECT JYQJ,
  SUM(JYJE) JYZE,
  COUNT(*) BS,

  Max(QJXH) QJXH,
  SUM(CASE WHEN JDBZ='出' THEN JYJE ELSE 0 END) CZJE,

  SUM(CASE WHEN JDBZ='出' THEN 1 else 0 end) as czbs,

  SUM(CASE WHEN JDBZ='进' THEN JYJE ELSE 0 END) JZJE,

  SUM(CASE WHEN JDBZ='进' THEN 1 else 0 end) as jzbs, 
  SUM(CASE WHEN JDBZ='进' THEN JYJE ELSE 0 END) -SUM(CASE WHEN JDBZ='出' THEN JYJE ELSE 0 END) JCZCE
  FROM
  (SELECT to_char(JYSJ::TIMESTAMP,'YYYY-MM') AS JYRQ,
   ( CASE WHEN JYJE< 10000 THEN '1万以下' 
    WHEN JYJE>= 10000  AND JYJE< 20000  THEN '1万-2万' 
    WHEN JYJE>= 20000  AND JYJE< 50000  THEN '2万-5万' 
    WHEN JYJE>= 50000  AND JYJE< 100000  THEN '5万-10万' 
    WHEN JYJE>= 100000  AND JYJE< 200000  THEN '10万-20万' 
    WHEN JYJE>= 200000  AND JYJE< 500000  THEN '20万-50万' 
    WHEN JYJE>= 500000  AND JYJE< 1000000  THEN '50万-100万' 
    WHEN JYJE>= 1000000  AND JYJE< 10000000  THEN '100万-1000万' 
    WHEN JYJE>= 10000000  AND JYJE< 100000000  THEN '1000万-10000万' 
    ELSE   '10000万以上' END 
   ) JYQJ,

   ( CASE WHEN JYJE< 10000 THEN 0 
    WHEN JYJE>= 10000  AND JYJE< 20000  THEN 1 
    WHEN JYJE>= 20000  AND JYJE< 50000  THEN 2 
    WHEN JYJE>= 50000  AND JYJE< 100000  THEN 3 
    WHEN JYJE>= 100000  AND JYJE< 200000  THEN 4 
    WHEN JYJE>= 200000  AND JYJE< 500000  THEN 5 
    WHEN JYJE>= 500000  AND JYJE< 1000000  THEN 6 
    WHEN JYJE>= 1000000  AND JYJE< 10000000  THEN 7 
    WHEN JYJE>= 10000000  AND JYJE< 100000000  THEN 8 
    ELSE  10 END 
   ) QJXH,
   JYJE,
   JDBZ
   FROM 
   mz_bank_records
   WHERE  AJID = 1447663931  AND JYJE IS NOT NULL) TT
  GROUP BY JYQJ ORDER BY QJXH  

)A WHERE 1=1 
```

##### 输出字段：

序号（++），交易区间(jyqj)，交易总金额(jyje)，交易总笔数(bs)，出账金额(czje)，出账笔数(czbs)，进账金额(jzje)，进账笔数(jzbs)，进出总差额(jczce)

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cmkq2oprj31iw0daaff.jpg)

#### 4. 交易时间段分析

> 统计各个时间段的交易次数、交易金额情况

```sql
SELECT
	* 
FROM
	(
    SELECT
    SUM( JYQJXH ) AS JYQJXH,
    JYQJ,
    SUM( JYZJE ) AS JYZJE,
    SUM( JYZBS ) AS JYZBS,
    SUM( CZJE ) AS CZJE,
    SUM( CZBS ) AS CZBS,
    SUM( JZJE ) AS JZJE,
    SUM( JZBS ) AS JZBS,
    SUM( JCZCE ) AS JCZCE 
    FROM
    (
      SELECT
      0 AS JYQJXH,
      to_number ( to_char ( JYSJ :: TIMESTAMP, 'HH24' ), '99' ) || '-' || to_number ( to_char ( JYSJ :: TIMESTAMP, 'HH24' ), '99' ) + 1 || '时' AS JYQJ,
      SUM( JYJE ) AS JYZJE,
      COUNT( 1 ) AS JYZBS,
      SUM( CASE JDBZ WHEN '出' THEN JYJE ELSE 0 END ) AS CZJE,
      SUM( CASE JDBZ WHEN '出' THEN 1 ELSE 0 END ) AS CZBS,
      SUM( CASE JDBZ WHEN '进' THEN JYJE ELSE 0 END ) AS JZJE,
      SUM( CASE JDBZ WHEN '进' THEN 1 ELSE 0 END ) AS JZBS,
      SUM( CASE JDBZ WHEN '进' THEN JYJE ELSE - JYJE END ) AS JCZCE 
      FROM
      mz_bank_records
      WHERE
      AJID = 1447663931  
      AND JYSJ IS NOT NULL 
      AND ( LENGTH( COALESCE ( JYSJ, '0' ) ) > 0 ) 
      AND to_char ( JYSJ :: TIMESTAMP, 'YYYY-MM-dd' ) >= '2010-01-01' 
      AND to_char ( JYSJ :: TIMESTAMP, 'YYYY-MM-dd' ) <= '2022-05-17' 
      GROUP BY
      to_char ( JYSJ :: TIMESTAMP, 'HH24' )
      UNION SELECT 1 AS JYQJXH, '0-1时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 2 AS JYQJXH, '1-2时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 3 AS JYQJXH, '2-3时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 4 AS JYQJXH, '3-4时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 5 AS JYQJXH, '4-5时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 6 AS JYQJXH, '5-6时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 7 AS JYQJXH, '6-7时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 8 AS JYQJXH, '7-8时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 9 AS JYQJXH, '8-9时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 10 AS JYQJXH, '9-10时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 11 AS JYQJXH, '10-11时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 12 AS JYQJXH, '11-12时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 13 AS JYQJXH, '12-13时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 14 AS JYQJXH, '13-14时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 15 AS JYQJXH, '14-15时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 16 AS JYQJXH, '15-16时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 17 AS JYQJXH, '16-17时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 18 AS JYQJXH, '17-18时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 19 AS JYQJXH, '18-19时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 20 AS JYQJXH, '19-20时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 21 AS JYQJXH, '20-21时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 22 AS JYQJXH, '21-22时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 23 AS JYQJXH, '22-23时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE
      UNION SELECT 24 AS JYQJXH, '23-24时' AS JYQJ, 0 AS JYZJE,0 AS JYZBS,0 AS CZJE,0 AS CZBS,0 AS JZJE,0 AS JZBS,0 AS JCZCE

    ) B GROUP BY JYQJ ) A 
WHERE
			1 = 1   ORDER BY JYQJXH ASC
```

##### 输出字段：

序号（++），时间段(jyqj)，交易总金额(jyzje)，交易总笔数(jyzbs)，出账金额(czje)，出账笔数(czbs)，进账金额(jzje)，进账笔数(jzbs)，进出账差额(jczce)

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cmfyp8a0j319c0cine8.jpg)

#### 5. 交易时间规律

> 以交易时间进行分组统计，统计出每个时间点的交易金额和交易次数

 ```sql
SELECT * FROM
(
  SELECT JYSJ,
  to_char(JYSJ::TIMESTAMP,'hh24:mi:ss') AS TIME,
  SUM( JYJE ) AS JYZJE,
  COUNT(1) AS JYZBS, 
  SUM(CASE JDBZ WHEN '出' THEN JYJE ELSE 0 END) AS CZJE, 
  SUM(CASE JDBZ WHEN '出' THEN 1 ELSE 0 END) AS CZBS, 
  SUM(CASE JDBZ WHEN '进' THEN JYJE ELSE 0 END) AS JZJE, 
  SUM(CASE JDBZ WHEN '进' THEN 1 ELSE 0 END) AS JZBS, 
  SUM(CASE JDBZ WHEN '进' THEN JYJE ELSE -JYJE END) AS JCZCE 
  FROM 
  mz_bank_records
  WHERE  AJID =  1447663931  and JYSJ is not null and to_char(JYSJ::TIMESTAMP,'hh24:mi:ss') <= '23:59:59' and to_char(JYSJ::TIMESTAMP,'hh24:mi:ss') >= '00:00:00' 
  GROUP BY JYSJ ORDER BY TIME DESC

)A WHERE 1=1 
 ```

##### 输出字段：

序号(++)，交易时间(jysj)，交易金额(jyzje)，交易总比数(jyzbs)，出账金额(czje)，出账笔数(czbs)，进账金额(jzje)，进账笔数(jzbs)，进出总差额(jczce)

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cmet99usj31ba0aiaog.jpg)

#### 6. 交易日期规律

> 以交易日期进行分组统计，统计出每个日期的交易金额和交易次数

```sql
SELECT * FROM

(

  SELECT to_char(JYSJ::TIMESTAMP,'YYYY-MM') AS JYRQ,
  SUM( JYJE ) AS JYZJE,
  COUNT(1) AS JYZBS, 
  SUM(CASE JDBZ WHEN '出' THEN JYJE ELSE 0 END) AS CZJE, 
  SUM(CASE JDBZ WHEN '出' THEN 1 ELSE 0 END) AS CZBS, 
  SUM(CASE JDBZ WHEN '进' THEN JYJE ELSE 0 END) AS JZJE, 
  SUM(CASE JDBZ WHEN '进' THEN 1 ELSE 0 END) AS JZBS, 
  SUM(CASE JDBZ WHEN '进' THEN JYJE ELSE -JYJE END) AS JCZCE 
  FROM 
  mz_bank_records	
  WHERE  AJID =  1447663931  And JYSJ is not null And (LENGTH( COALESCE(JYSJ, '0'))>0)
  GROUP BY to_char(JYSJ::TIMESTAMP,'YYYY-MM') ORDER BY JYRQ 

)A WHERE 1=1 
```

##### 输出字段：

序号（++），交易日期(jyrq)，交易金额(jyzje)，交易总笔数(jyzbs)，出账金额(czje)，出账笔数(czbs)，进账金额(jzje)，进账笔数(jzbs)，进出总差额(jczce)

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cme1gip6j313e0cydvk.jpg)

#### 7. 交易方式规律

> 根据交易说明进行分组查询

```sql
SELECT * FROM(
  SELECT ZYSM, COUNT(1) ALLCOUNT,
  SUM(CASE JDBZ WHEN '进' THEN 1 ELSE 0 END) INCOUNT,
  SUM(CASE JDBZ WHEN '进' THEN JYJE ELSE 0 END) INJE ,
  SUM(CASE JDBZ WHEN '出' THEN 1 ELSE 0 END) OUTCOUNT, 
  SUM(CASE JDBZ WHEN '出' THEN JYJE ELSE 0 END) OUTJE 
  FROM   
  mz_bank_records
  WHERE AJID=1447663931  AND ZYSM IS NOT NULL AND LENGTH( COALESCE(ZYSM, '0'))>0
  GROUP BY ZYSM ORDER BY ALLCOUNT DESC  
)A WHERE 1=1 
```



##### 输出字段：

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cmd94jb1j31h40b4tco.jpg)

#### 8.调集人员交易进出情况

> 统计所有调单方（即交易方）交易户名的交易金额与交易笔数情况。
>
> 满足交易名称和交易证件号码不为空，按着交易名称和交易证件号码的分组查询
>
> 

```sql
select
	JYHM,        /*交易户名*/
	JYSFZH,      /*交易证件卡号*/
	JYKHS,       /*调集银行卡数量*/
	JYDFZJHMS,   /*对手人数*/
	JYDFZKHS,    /*对手账户数*/
	ZCZJE ZCZJE, /*转出总金额*/
	ZCZCS ZCZCS, /*转出总次数*/
	ZRZJE ZRZJE, /*转入总金额*/
	ZRZCS ZRZCS, /*转入总次数*/
	JYZJE JYZJE  /*交易总金额*/
from
	(
    select
    A .*
    from
    (
      select
      JYMC JYHM, 
      JYZJHM JYSFZH, 
      COUNT(distinct CXKH) JYKHS, /**/
      COUNT(distinct JYDFZKH) JYDFZKHS,
      COUNT(distinct JYDFZJHM) JYDFZJHMS,
      SUM(case JDBZ when '出' then ABS (JYJE) else 0 end) ZCZJE,
      SUM(case JDBZ when '出' then 1 else 0 end) ZCZCS,
      SUM( case JDBZ when '进' then ABS (JYJE) else 0 end ) ZRZJE,
      SUM( case JDBZ  when '进' then 1 else 0 end) ZRZCS,
      SUM(ABS(JYJE)) JYZJE
      from
      mz_bank_records
      where
      AJID = 990675050
      and JYMC is not null
      and LENGTH( coalesce(JYMC, '0'))>0
      and JYZJHM is not null  									/*jyzjhm交易证件号码*/
      and LENGTH( coalesce(JYZJHM, '0'))>0
      group by JYMC, JYZJHM ) A
  ) B
where
	1 = 1
order by
	JYZJE desc
```

##### 输出字段：

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2ewjfsofrj31ue04wmzi.jpg)

### 六、基于IP团伙分析模型 （同MAC分析模型）

#### 1. IP关联账户数统计

```sql
SELECT
    IP,
    jdbz,
    COUNT ( DISTINCT cxkh ) glddzhs,
    COUNT ( DISTINCT jymc ) glddrs,
    COUNT ( DISTINCT jydfzkh ) glczdszhs,
    COUNT ( * ) ipcxcs,
    SUM ( jyje ) ipcxje 
    FROM
    mz_bank_records
    WHERE
    ajid =1447663931  
    AND ip IS NOT NULL 
    AND jdbz = '出' 
    GROUP BY
    IP,
    jdbz order by glddzhs desc 
```

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cmcmq8xoj31h60f2h1k.jpg)

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cnj1re6jj32h60ikgsz.jpg)

#### 2. IP关联账户详细分析

```sql
SELECT
    IP,
    jdbz,
    cxkh,
    jymc,
    COUNT ( * ) sjcs,
    SUM ( jyje ) sjje 
    FROM
    mz_bank_records
    WHERE
    ajid =1447663931  
    AND ip IS NOT NULL 
    AND jdbz = '出' 
    GROUP BY
    IP,
    jdbz,
    cxkh,
    jymc order by ip desc 
```

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cmc7tnyjj31h40emndi.jpg)

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cnjws72oj32ha0hgtfx.jpg)

#### 3. 同IP关联账户分析

```sql
   SELECT
    IP,
    jdbz,
    cxkh,
    jymc,
    COUNT ( * ) cs,
    SUM ( jyje ) sjje 
    FROM
   	mz_bank_records
    WHERE
    ajid =1447663931  
    AND ip IS NOT NULL 
    AND jdbz = '出' 
    GROUP BY
    IP,
    jdbz,
    cxkh,
    jymc 
    HAVING
    COUNT ( DISTINCT cxkh ) > 0  order by ip desc 
```

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cmbw0mlij31h60c64c9.jpg)

#### 4. 账户关联IP数量统计

```sql
SELECT
    IP,
    jdbz,
    cxkh,
    jymc,
    COUNT ( * ) cs,
    SUM ( jyje ) sjje 
    FROM
   mz_bank_records
    WHERE
    ajid =1447663931  
    AND ip IS NOT NULL 
    AND jdbz = '出' 
    GROUP BY
    IP,
    jdbz,
    cxkh,
    jymc 
    HAVING
    COUNT ( DISTINCT cxkh ) > 0  order by ip desc 
```

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cmblwvg1j31gq0dqaps.jpg)

#### 5.账户关联IP详细分析

```sql
SELECT
    cxkh,
    jymc,
    jdbz,
    IP,
    COUNT ( * ) cs,
    SUM ( jyje ) sjje 
    FROM
    mz_bank_records
    WHERE
    ajid =1447663931  
    AND ip IS NOT NULL 
    AND jdbz = '出' 
    GROUP BY
    cxkh,
    jymc,
    jdbz,
    IP order by cxkh desc 
```

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2cmb3giv4j31gw0hk4ij.jpg)



### 七、亲密度分析模型

> 查找调单数据中出现频次最高的主体交易户名

```sql
SELECT
	* 
FROM
	(
    SELECT
    hm,
    jyzjhm,
    qmd,      /*亲密度*/
    jyzje,
    jyzbs,
    jzdss,
    jzje,
    jzbs,
    czdss,
    czje,
    czbs,
    jczce,
    zzjyrq,
    zwjyrq,
    CASE WHEN ddqk IS NULL 
    THEN  /*ddqk 调单情况*/ 
    '未调单' 
    ELSE'已调单' 
    END ddqk 
    FROM
    (
      SELECT
      hm,
      SUM ( qmd ) AS qmd 
      FROM
      (
        SELECT
        jymc AS hm,
        COUNT ( jymc ) AS qmd 
        FROM
        (
          SELECT DISTINCT
          CASE
          WHEN
          jdbz = '进' THEN
          jydfmc ELSE jymc 
          END AS jymc
          FROM
          mz_bank_records
          WHERE
          AJID =990675050  
        ) A 
        GROUP BY
        jymc UNION ALL
        SELECT
        jydfmc AS hm,
        COUNT ( jydfmc ) AS qmd 
        FROM
        (
          SELECT DISTINCT
          CASE
          WHEN
          jdbz = '进' THEN
          jymc ELSE jydfmc 
          END AS jydfmc
          FROM
          mz_bank_records
          WHERE
          AJID =990675050  
        ) A 
        GROUP BY
        jydfmc 
      ) A 
      GROUP BY
      hm 
    )
    A LEFT JOIN (
      SELECT
      jymc,
      MAX ( jyzjhm ) AS jyzjhm,
      SUM ( JYJE ) AS JYZJE,
      COUNT ( JYJE ) AS JYZBS,
      SUM ( CASE WHEN ( JDBZ = '出' ) THEN JYJE ELSE 0 END ) AS CZJE,
      SUM ( CASE WHEN ( JDBZ = '出' ) THEN 1 ELSE 0 END ) AS CZBS,
      COUNT ( DISTINCT ( CASE JDBZ WHEN '出' THEN JYDFMC END ) ) AS CZDSS,
      SUM ( CASE WHEN ( JDBZ = '进' ) THEN JYJE ELSE 0 END ) AS JZJE,
      SUM ( CASE WHEN ( JDBZ = '进' ) THEN 1 ELSE 0 END ) AS JZBS,
      COUNT ( DISTINCT ( CASE JDBZ WHEN '进' THEN JYDFMC END ) ) AS JZDSS,
      SUM ( CASE WHEN ( JDBZ = '进' ) THEN JYJE ELSE - JYJE END ) AS JCZCE,
      MIN ( JYSJ ) AS ZZJYRQ,
      MAX ( JYSJ ) AS ZWJYRQ,
      '已调单' AS DDQK 
      FROM
      mz_bank_records
      WHERE
      AJID =990675050 
      GROUP BY
      jymc 
    ) B ON A.hm = B.jymc order by qmd desc 
  ) D 
WHERE
	1 = 1 
```

内部子查询sql统计出来亲密度，然后统计其他数据

```sql
select
	hm,
	SUM (qmd) as qmd
from
	(
    select
    jymc as hm,
    COUNT (jymc) as qmd
    from
    (
      select
      distinct
      case
      when
      jdbz = '进' then
      jydfmc
      else jymc
      end as jymc
      from
      mz_bank_records
      where
      AJID = 990675050  
    ) A
    group by
    jymc
    union all
    select
    jydfmc as hm,
    COUNT (jydfmc) as qmd
    from
    (
      select
      distinct
      case
      when
      jdbz = '进' then
      jymc
      else jydfmc
      end as jydfmc
      from
      mz_bank_records
      where
      AJID = 990675050  
    ) A
    group by
    jydfmc 
  ) A
group by
	hm
```

##### 输出字段：

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2f17m8im8j329w0ien41.jpg)

### 八、资金透视模型

> 针对资金数据自定义维度，进行透视分析

```sql
select
	*
from
	(
	select
		CXZH,
		JYDFZKH,
		JDBZ,
		JYZBS,
		DSSL,
		JYZJE,
		case
			when JYZBS is null
			or JYZBS = 0 then 0
			else ROUND(JYZJE / JYZBS, 2)
		end as JYZEPJZ,
		JZJE,
		CZJE,
		case
			when JYZJE is null
			or JYZJE = 0 then '0%'
			else ROUND(JZJE * 100 / JYZJE, 2)|| '%'
		end as JZJEZB,
		case
			when JYZJE is null
			or JYZJE = 0 then '0%'
			else ROUND(CZJE * 100 / JYZJE, 2)|| '%'
		end as CZJEZB,
		case
			when CZJE is null
			or CZJE = 0 then 0
			else ROUND(JZJE / CZJE, 2)
		end as JCJEBL
	from
		(
		select
			CXZH,
			JYDFZKH,
			JDBZ,
			COUNT (1) as JYZBS,
			COUNT ( distinct JYDFZKH1 ) as DSSL,
			SUM ( case
				when JYJE1 is null then 0
				else JYJE1
			end ) as JYZJE,
			SUM ( case
				when ( JDBZ1 = '进' ) then JYJE1
				else 0
			end ) as JZJE,
			SUM ( case
				when ( JDBZ1 = '出' ) then JYJE1
				else 0
			end ) as CZJE
		from
			(
			select
				case
					when CXZH = '' then null
					else CXZH
				end as CXZH,
				case
					when JYDFZKH = '' then null
					else JYDFZKH
				end as JYDFZKH,
				case
					when JDBZ = '' then null
					else JDBZ
				end as JDBZ ,
				case
					when JYDFZKH = '' then null
					else JYDFZKH
				end as JYDFZKH1,
				JYJE as JYJE1,
				case
					when JDBZ = '' then null
					else JDBZ
				end as JDBZ1
			from
				mz_bank_records
			where
				AJID = 1447663931   

                ) A
		group by
			CXZH,
			JYDFZKH,
			JDBZ ) B ) C
where
	1 = 1
order by
	JYZBS desc
```

##### 输出字段：

![image.png](http://tva1.sinaimg.cn/large/0074iuxmly1h2f18h1krbj329i0r07ix.jpg)